<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Juice Flashcards">
    <title>Juice Flashcards</title>
    <style>
        /* ====================================================
           GLOBAL STYLES
           ==================================================== */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            max-width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #000;
        }

        body {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        /* ====================================================
           APP CONTAINER & SCREENS
           ==================================================== */

        #app {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .screen.active {
            display: flex;
            z-index: 10;
        }

        /* ====================================================
           PROFILE SELECTION SCREEN
           ==================================================== */

        #profile-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            justify-content: center;
            align-items: center;
        }

        .profile-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-header h1 {
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .profile-header p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        .profile-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .profile-btn {
            padding: 16px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            text-align: left;
            touch-action: manipulation;
        }

        .profile-btn:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.25);
        }

        .profile-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .profile-stats {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }

        .new-profile-section {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .profile-input {
            flex: 1;
            padding: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 14px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            outline: none;
        }

        .profile-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .profile-input:focus {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn-create-profile {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 215, 0, 0.3);
            border: 2px solid rgba(255, 215, 0, 0.5);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
            touch-action: manipulation;
        }

        .btn-create-profile:active {
            transform: scale(0.95);
            background: rgba(255, 215, 0, 0.4);
        }

        /* ====================================================
           STUDY SCREEN
           ==================================================== */

        #study-screen {
            background: #000;
            padding: 0;
        }

        .study-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .flip-card-container {
            perspective: 1500px;
            position: relative;
            width: 100%;
            height: 80vh;
            max-height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Enhanced animation keyframes for the flip */
        @keyframes flipToBack {
            0% {
                transform: rotateY(0deg) rotateX(0deg);
                filter: blur(0px);
            }
            15% {
                filter: blur(0.5px);
            }
            50% {
                transform: rotateY(90deg) rotateX(0deg) translateZ(50px);
                filter: blur(1px);
            }
            85% {
                filter: blur(0.5px);
            }
            100% {
                transform: rotateY(180deg) rotateX(0deg);
                filter: blur(0px);
            }
        }

        @keyframes flipToFront {
            0% {
                transform: rotateY(180deg) rotateX(0deg);
                filter: blur(0px);
            }
            15% {
                filter: blur(0.5px);
            }
            50% {
                transform: rotateY(90deg) rotateX(0deg) translateZ(50px);
                filter: blur(1px);
            }
            85% {
                filter: blur(0.5px);
            }
            100% {
                transform: rotateY(0deg) rotateX(0deg);
                filter: blur(0px);
            }
        }

        /* Content fade animations */
        @keyframes fadeOutContent {
            0% {
                opacity: 1;
                filter: blur(0px);
            }
            30% {
                opacity: 0.8;
                filter: blur(0px);
            }
            50% {
                opacity: 0;
                filter: blur(2px);
            }
            100% {
                opacity: 0;
                filter: blur(2px);
            }
        }

        @keyframes fadeInContent {
            0% {
                opacity: 0;
                filter: blur(2px);
            }
            50% {
                opacity: 0;
                filter: blur(2px);
            }
            70% {
                opacity: 0.8;
                filter: blur(0px);
            }
            100% {
                opacity: 1;
                filter: blur(0px);
            }
        }

        .flip-card {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            filter: drop-shadow(0 20px 80px rgba(0, 0, 0, 0.6));
        }

        .flip-card.flipped {
            animation: flipToBack 1.2s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
        }

        .flip-card.unflipped {
            animation: flipToFront 1.2s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
        }

        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            border-radius: 20px;
            box-sizing: border-box;
            overflow: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.3), inset 0 -1px 1px rgba(0, 0, 0, 0.3);
        }

        .flip-card-front {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);
            z-index: 2;
        }

        .flip-card-back {
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.8) 0%, rgba(245, 87, 108, 0.8) 100%);
            transform: rotateY(180deg);
            z-index: 1;
            opacity: 0;
        }

        /* Ensure back card is visible when flipped */
        .flip-card.flipped .flip-card-back {
            opacity: 1;
        }

        /* Fade out front content during flip */
        .flip-card.flipped .flip-card-front {
            animation: fadeOutContent 1.2s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
        }

        /* Fade in back content during flip */
        .flip-card.flipped .flip-card-back {
            animation: fadeInContent 1.2s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
        }

        /* Fade in front content when returning */
        .flip-card.unflipped .flip-card-front {
            animation: fadeInContent 1.2s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
        }

        /* Fade out back content when returning */
        .flip-card.unflipped .flip-card-back {
            animation: fadeOutContent 1.2s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
        }

        .card-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 12px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        .cloze-text {
            font-size: 20px;
            line-height: 1.8;
            font-weight: 500;
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            word-break: break-word;
            max-width: 95%;
            overflow-wrap: break-word;
            padding: 0 15px;
            white-space: normal;
            text-align: center;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 4px;
        }

        .cloze-blank {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            border: 2px dashed rgba(255, 215, 0, 0.7);
            padding: 8px 24px;
            border-radius: 8px;
            min-width: 120px;
            margin: 0 4px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .cloze-hint {
            display: inline-block;
            background: rgba(255, 215, 0, 0.5);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 700;
            margin: 0 2px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            font-size: 14px;
        }

        .cloze-complete {
            display: inline-block;
            background: rgba(76, 175, 80, 0.4);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 700;
            margin: 0 2px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            font-size: 16px;
        }

        .answer-input-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            justify-content: center;
        }

        .answer-input {
            width: 100%;
            max-width: 300px;
            padding: 14px 18px;
            font-size: 16px;
            font-weight: 500;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-align: center;
            outline: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Prevent iOS auto-zoom on input focus */
        @supports (-webkit-touch-callout: none) {
            .answer-input {
                font-size: 16px;
            }
        }

        .answer-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .answer-input:focus {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: scale(1.02);
        }

        .check-answer-btn {
            width: 100%;
            max-width: 300px;
            padding: 14px 18px;
            font-size: 16px;
            font-weight: 600;
            border: 2px solid rgba(255, 215, 0, 0.6);
            border-radius: 12px;
            background: rgba(255, 215, 0, 0.3);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .check-answer-btn:hover {
            background: rgba(255, 215, 0, 0.5);
            border-color: rgba(255, 215, 0, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 215, 0, 0.3);
        }

        .check-answer-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.2);
        }

        .comparison-section {
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            display: none;
        }

        .comparison-section.show {
            display: block;
        }

        .comparison-box {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .comparison-item {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.1);
        }

        .comparison-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
        }

        .comparison-value {
            font-size: 14px;
            font-weight: 700;
            color: white;
            word-break: break-word;
            min-height: 20px;
        }

        .comparison-divider {
            width: 1px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }

        .feedback-message {
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            padding: 8px 0;
            min-height: 18px;
        }

        .feedback-correct {
            color: #4CAF50;
        }

        .feedback-close {
            color: #FFC107;
        }

        .feedback-acceptable {
            color: #FF9800;
        }

        .feedback-incorrect {
            color: #FF6B6B;
        }

        .feedback-forbidden {
            color: #FF5252;
            font-weight: 700;
        }

        .rating-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 300px;
            margin-top: 20px;
        }

        .rating-btn {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.15);
            color: white;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            touch-action: manipulation;
            min-height: 70px;
        }

        .rating-icon {
            font-size: 22px;
            line-height: 1;
        }

        .rating-time {
            font-size: 9px;
            opacity: 0.7;
        }

        .rating-key {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 11px;
            font-weight: 700;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            opacity: 0.8;
        }

        .rating-btn:active {
            transform: scale(0.95);
            background: rgba(0, 0, 0, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .rating-btn.again {
            border-color: rgba(244, 67, 54, 0.5);
            background: rgba(244, 67, 54, 0.15);
        }

        .rating-btn.hard {
            border-color: rgba(255, 152, 0, 0.5);
            background: rgba(255, 152, 0, 0.15);
        }

        .rating-btn.good {
            border-color: rgba(76, 175, 80, 0.5);
            background: rgba(76, 175, 80, 0.15);
        }

        .rating-btn.easy {
            border-color: rgba(76, 175, 80, 0.5);
            background: rgba(76, 175, 80, 0.15);
        }

        .study-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .profile-display {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .xp-display {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 215, 0, 0.9);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .level-display {
            text-align: center;
        }

        .level-number {
            font-size: 18px;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .level-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .btn-back-to-profile {
            padding: 10px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            touch-action: manipulation;
        }

        .btn-back-to-profile:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.2);
        }

        .footer-buttons {
            display: flex;
            gap: 8px;
        }

        .footer-btn {
            padding: 8px 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .footer-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .footer-btn:active {
            transform: scale(0.95);
        }

        /* Mobile Responsive - CSS-only viewport adaptation */
        @media (max-width: 640px) {
            #study-screen {
                background: #000;
            }

            #profile-screen {
                padding: 15px;
            }

            .profile-header h1 {
                font-size: 28px;
            }

            .study-container {
                padding: 0;
                width: 100%;
                display: flex;
                flex-direction: column;
                min-height: 100dvh;
                background: #000;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .flip-card-container {
                width: 100%;
                flex: 0 0 auto;
                margin: 0;
                display: flex;
                min-height: calc(100dvh - 120px);
            }

            .flip-card {
                width: 100%;
                display: flex;
            }

            .flip-card-front,
            .flip-card-back {
                display: flex;
                flex-direction: column;
                width: 100%;
                padding: 15px;
            }

            .card-label {
                font-size: 11px;
                margin-bottom: 6px;
                flex-shrink: 0;
            }

            .card-content {
                gap: 3px;
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
            }

            .cloze-text {
                font-size: 15px;
                max-width: 100%;
                line-height: 1.3;
                word-break: break-word;
            }

            .answer-input-wrapper {
                gap: 5px;
                width: 100%;
                margin-top: 8px;
                padding: 0;
                flex-shrink: 0;
            }

            .answer-input {
                width: 100%;
                max-width: 100%;
                font-size: 16px;
                padding: 10px;
            }

            .check-answer-btn {
                width: 100%;
                max-width: 100%;
                font-size: 13px;
                padding: 10px;
            }

            .comparison-section {
                width: 100%;
                max-width: 100%;
                margin: 6px 0;
                flex-shrink: 0;
            }

            .comparison-box {
                gap: 8px;
            }

            .rating-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 6px;
                margin: 6px -15px 0 -15px;
                padding: 8px 15px 15px 15px;
                flex-shrink: 0;
            }

            .rating-btn {
                min-height: 50px;
                font-size: 9px;
                padding: 8px;
            }

            .study-footer {
                width: 100%;
                padding: 8px 10px;
                gap: 5px;
                font-size: 11px;
                flex-shrink: 0;
                background: #000;
                border-top: 1px solid rgba(255,255,255,0.1);
            }
        }

        /* ====================================================
           AUTHENTICATION SCREENS (LOGIN & SIGNUP)
           ==================================================== */

        #login-screen,
        #signup-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            justify-content: center;
            align-items: center;
        }

        .auth-container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .auth-header h1 {
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .auth-header p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: transparent;
            padding: 25px;
            border-radius: 12px;
        }

        .auth-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .auth-form-group label {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }

        .auth-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transition: all 0.2s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .auth-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .auth-error {
            color: #d32f2f;
            font-size: 13px;
            text-align: center;
            padding: 10px;
            background: rgba(211, 47, 47, 0.1);
            border-radius: 6px;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        .auth-footer {
            text-align: center;
            margin-top: 10px;
        }

        .auth-footer p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 10px;
        }

        .link-btn {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .link-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
        }

        .link-btn:active {
            transform: scale(0.98);
        }

        /* Responsive - Mobile */
        @media (max-width: 480px) {
            .auth-container {
                max-width: 100%;
                padding: 0;
            }

            .auth-header h1 {
                font-size: 28px;
            }

            .auth-form {
                border-radius: 16px 16px 0 0;
                padding: 20px;
                gap: 12px;
            }

            .auth-input {
                font-size: 16px;
                padding: 14px;
            }

            .auth-btn {
                padding: 16px;
                font-size: 16px;
            }
        }

        /* ====================================================
           ANALYTICS SCREEN
           ==================================================== */

        #analytics-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow-y: auto;
            padding: 20px;
        }

        .analytics-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 30px;
        }

        .analytics-header h1 {
            font-size: 32px;
            margin: 0;
        }

        .back-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .chart-container h3 {
            margin-top: 0;
            color: #333;
            font-size: 18px;
        }

        .chart-container canvas {
            max-width: 100%;
        }

        .struggled-cards-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .struggled-cards-section h3 {
            margin-top: 0;
            color: #333;
        }

        .struggled-cards-list {
            list-style: none;
            padding: 0;
        }

        .struggled-card-item {
            padding: 12px;
            background: #f5f5f5;
            border-left: 4px solid #667eea;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .struggled-card-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .struggled-card-stats {
            font-size: 13px;
            color: #666;
        }

        /* ====================================================
           SETTINGS SCREEN
           ==================================================== */

        #settings-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow-y: auto;
            padding: 20px;
        }

        .settings-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 30px;
        }

        .settings-header h1 {
            font-size: 32px;
            margin: 0;
        }

        .settings-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .settings-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #eee;
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section h2 {
            font-size: 18px;
            color: #333;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 14px;
        }

        .info-row .label {
            font-weight: 600;
            color: #666;
        }

        .info-row .value {
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group.checkbox {
            margin-bottom: 10px;
        }

        .form-group.checkbox label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            margin: 0;
        }

        .form-group.checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .form-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .form-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .form-btn:active {
            transform: translateY(0);
        }

        .logout-btn {
            width: 100%;
            padding: 12px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: #b71c1c;
        }

        .error-message {
            color: #d32f2f;
            font-size: 13px;
            margin-top: 10px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* ====================================================
           ADMIN SCREEN
           ==================================================== */

        #admin-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow-y: auto;
            padding: 20px;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 30px;
        }

        .admin-header h1 {
            font-size: 32px;
            margin: 0;
            flex: 1;
            text-align: center;
        }

        .admin-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .admin-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .users-list-container {
            overflow-x: auto;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .users-table thead {
            background: #f5f5f5;
            font-weight: 600;
        }

        .users-table th {
            padding: 12px;
            text-align: left;
            color: #333;
            border-bottom: 2px solid #ddd;
        }

        .users-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            color: #333;
        }

        .users-table tbody tr:hover {
            background: #fafafa;
        }

        /* Card Management Styles */
        .card-management-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }

        .card-management-section h2 {
            margin-top: 0;
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .card-management-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* File Upload Modal */
        .file-drop-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background: #f0f4ff;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 15px;
        }

        .file-drop-area:hover {
            background: #e8f0ff;
            border-color: #764ba2;
        }

        .file-drop-area.dragover {
            background: #e8f0ff;
            border-color: #764ba2;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .file-drop-area p {
            margin: 0;
            font-size: 16px;
            color: #667eea;
            font-weight: 500;
        }

        /* Upload Steps */
        .upload-step {
            margin-bottom: 20px;
        }

        .upload-step h3 {
            color: #333;
            font-size: 16px;
            margin-top: 0;
            margin-bottom: 15px;
        }

        /* Validation Messages */
        .validation-output {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .validation-message {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .validation-message.error {
            background: #fee;
            color: #c33;
            border-left: 4px solid #c33;
        }

        .validation-message.warning {
            background: #ffd;
            color: #774;
            border-left: 4px solid #b80;
        }

        .validation-message.success {
            background: #efe;
            color: #3c3;
            border-left: 4px solid #3c3;
        }

        .validation-message.info {
            background: #eef;
            color: #33c;
            border-left: 4px solid #33c;
        }

        /* CSV Preview Table */
        .csv-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .csv-preview table {
            border-collapse: collapse;
            font-size: 12px;
            width: 100%;
        }

        .csv-preview table th {
            background: #f5f5f5;
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
            font-weight: 600;
        }

        .csv-preview table td {
            padding: 8px;
            border: 1px solid #eee;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Form Control Styles */
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group small {
            display: block;
            color: #666;
            font-size: 12px;
            margin-top: 4px;
        }

        /* Upload Actions */
        .upload-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .form-btn.secondary {
            background: #ddd;
            color: #333;
        }

        .form-btn.secondary:hover {
            background: #ccc;
        }

        /* Status Message */
        .status-message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            display: none;
        }

        .status-message.error {
            background: #fee;
            color: #c33;
            border: 1px solid #ddd;
            display: block;
        }

        .status-message.success {
            background: #efe;
            color: #3c3;
            border: 1px solid #ddd;
            display: block;
        }

        .status-message.loading {
            background: #eef;
            color: #33c;
            border: 1px solid #ddd;
            display: block;
        }

        .user-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .user-action-btn {
            padding: 6px 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-action-btn:hover {
            background: #5568d3;
        }

        .user-action-btn.danger {
            background: #d32f2f;
        }

        .user-action-btn.danger:hover {
            background: #b71c1c;
        }

        /* Modal Styling */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            position: relative;
        }

        .close-modal {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close-modal:hover {
            color: #333;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #333;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .analytics-header,
            .settings-header,
            .admin-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .back-btn {
                align-self: flex-start;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .admin-actions {
                flex-direction: column;
            }

            .search-input {
                flex: none;
                width: 100%;
            }

            .users-table {
                font-size: 13px;
            }

            .users-table th,
            .users-table td {
                padding: 8px;
            }
        }

        @media (max-width: 480px) {
            .analytics-header h1,
            .settings-header h1,
            .admin-header h1 {
                font-size: 24px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .settings-content {
                padding: 20px;
            }

            .user-actions {
                flex-direction: column;
            }

            .user-action-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            .flip-card,
            .rating-btn,
            .profile-btn,
            .answer-input,
            .auth-btn,
            .link-btn,
            .back-btn,
            .form-btn,
            .logout-btn,
            .action-btn,
            .user-action-btn {
                transition: none;
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

    <!-- Chart.js for analytics visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Firebase Auth Module (our custom authentication) -->
    <script src="firebase-auth.js"></script>
</head>
<body>
    <div id="app">
        <!-- Login Screen -->
        <div id="login-screen" class="screen">
            <div class="auth-container">
                <div class="auth-header">
                    <h1>Juice Training</h1>
                    <p>Sign in to continue</p>
                </div>

                <div class="auth-form">
                    <input
                        type="text"
                        id="login-username"
                        class="auth-input"
                        placeholder="Username"
                        autocomplete="off">
                    <input
                        type="password"
                        id="login-pin"
                        class="auth-input"
                        placeholder="PIN (4 digits)"
                        maxlength="4"
                        inputmode="numeric"
                        autocomplete="off">
                    <button class="auth-btn" id="login-btn">Sign In</button>
                </div>

                <div class="auth-footer">
                    <p>Don't have an account?</p>
                    <button class="link-btn" id="goto-signup-btn">Sign Up</button>
                </div>

                <div id="login-error" class="auth-error"></div>
            </div>
        </div>

        <!-- Signup Screen -->
        <div id="signup-screen" class="screen">
            <div class="auth-container">
                <div class="auth-header">
                    <h1>Juice Training</h1>
                    <p>Create your account</p>
                </div>

                <div class="auth-form">
                    <input
                        type="text"
                        id="signup-username"
                        class="auth-input"
                        placeholder="Choose username (2-20 chars)"
                        autocomplete="off">
                    <input
                        type="password"
                        id="signup-pin"
                        class="auth-input"
                        placeholder="Create PIN (4 digits)"
                        maxlength="4"
                        inputmode="numeric"
                        autocomplete="off">
                    <input
                        type="password"
                        id="signup-pin-confirm"
                        class="auth-input"
                        placeholder="Confirm PIN"
                        maxlength="4"
                        inputmode="numeric"
                        autocomplete="off">
                    <button class="auth-btn" id="signup-btn">Sign Up</button>
                </div>

                <div class="auth-footer">
                    <p>Already have an account?</p>
                    <button class="link-btn" id="goto-login-btn">Sign In</button>
                </div>

                <div id="signup-error" class="auth-error"></div>
            </div>
        </div>

        <!-- Profile Selection Screen -->
        <div id="profile-screen" class="screen">
            <div class="profile-container">
                <div class="profile-header">
                    <h1>Juice Training</h1>
                    <p>Select or create a profile</p>
                    <button id="logout-btn" style="margin-top: 15px; padding: 8px 20px; background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s ease;">Sign Out</button>
                </div>

                <div class="profile-list" id="profile-list"></div>

                <div class="new-profile-section">
                    <input
                        type="text"
                        id="profile-name-input"
                        class="profile-input"
                        placeholder="Enter your name..."
                        autocomplete="off">
                    <button class="btn-create-profile" id="create-profile-btn">Create</button>
                </div>

                <!-- Category Selector Section -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-bottom: 10px; font-weight: 600; text-align: left;">
                         Select Study Material:
                    </div>
                    <select id="card-set-selector" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.3); color: white; font-size: 13px; cursor: pointer; transition: all 0.2s ease; margin-bottom: 10px;">
                        <option value="">-- Loading card sets --</option>
                    </select>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: left; margin-top: 5px;">
                         Different card sets for different products
                    </div>
                </div>

                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 10px; text-align: center;">
                        Use the "Select Study Material" dropdown to choose cards
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Selection Modal -->
        <div id="category-selection-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: linear-gradient(135deg, rgba(20, 20, 30, 0.95) 0%, rgba(30, 30, 50, 0.95) 100%); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);">
                <h2 style="color: white; margin-bottom: 10px; text-align: center; font-size: 20px;"> Select Study Material</h2>
                <p style="color: rgba(255, 255, 255, 0.7); text-align: center; margin-bottom: 20px; font-size: 14px;">Choose which cards you'd like to study:</p>

                <select id="category-selection-dropdown" style="width: 100%; padding: 12px; border-radius: 6px; border: 1px solid rgba(255, 215, 0, 0.3); background: rgba(0, 0, 0, 0.3); color: white; font-size: 14px; cursor: pointer; margin-bottom: 20px;">
                    <option value="">-- Loading categories --</option>
                </select>

                <button id="category-confirm-btn" style="width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.8); border: none; border-radius: 6px; color: black; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                    Start Studying 
                </button>

                <div style="text-align: center; margin-top: 15px;">
                    <button id="category-logout-btn" style="background: none; border: none; color: rgba(255, 255, 255, 0.6); cursor: pointer; font-size: 12px; text-decoration: underline;">
                         Back to Login
                    </button>
                </div>
            </div>
        </div>

        <!-- Study Screen -->
        <div id="study-screen" class="screen">
            <div class="study-container">
                <div class="flip-card-container">
                    <div class="flip-card" id="flip-card">
                        <!-- Front Card -->
                        <div class="flip-card-front">
                            <div class="card-label">Question</div>
                            <div class="card-content">
                                <div class="cloze-text" id="front-cloze"></div>
                                <div class="answer-input-wrapper">
                                    <input
                                        type="text"
                                        id="user-answer-input"
                                        class="answer-input"
                                        placeholder="Type your answer..."
                                        autocomplete="off"
                                        spellcheck="false">
                                    <button id="check-answer-btn" class="check-answer-btn">Check Answer</button>
                                    <small style="color: rgba(255,255,255,0.6); font-size: 11px;">Or press Enter</small>
                                </div>
                            </div>
                        </div>

                        <!-- Back Card -->
                        <div class="flip-card-back">
                            <div class="card-label">Answer</div>
                            <div class="card-content">
                                <div class="cloze-text" id="back-cloze"></div>
                                <div class="comparison-section" id="comparison-section">
                                    <div class="comparison-box">
                                        <div class="comparison-item">
                                            <div class="comparison-label">Your Answer</div>
                                            <div class="comparison-value" id="your-answer-display">-</div>
                                        </div>
                                        <div class="comparison-divider"></div>
                                        <div class="comparison-item">
                                            <div class="comparison-label">Expected</div>
                                            <div class="comparison-value" id="expected-answer-display">-</div>
                                        </div>
                                    </div>
                                    <div class="feedback-message" id="feedback-message"></div>
                                </div>
                                <div class="rating-buttons">
                                    <button class="rating-btn again" data-rating="again">
                                        <span class="rating-icon"></span>
                                        <span>Again</span>
                                        <span class="rating-time">1m</span>
                                        <span class="rating-key">1</span>
                                    </button>
                                    <button class="rating-btn hard" data-rating="hard">
                                        <span class="rating-icon"></span>
                                        <span>Hard</span>
                                        <span class="rating-time">10m</span>
                                        <span class="rating-key">2</span>
                                    </button>
                                    <button class="rating-btn good" data-rating="good">
                                        <span class="rating-icon"></span>
                                        <span>Good</span>
                                        <span class="rating-time">3d</span>
                                        <span class="rating-key">3</span>
                                    </button>
                                    <button class="rating-btn easy" data-rating="easy">
                                        <span class="rating-icon"></span>
                                        <span>Easy</span>
                                        <span class="rating-time">4d</span>
                                        <span class="rating-key">4</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="study-footer">
                <div class="profile-display" id="current-profile">Profile: -</div>
                <div class="level-display">
                    <div class="level-number" id="current-level">1</div>
                    <div class="level-label">LEVEL</div>
                </div>
                <div class="xp-display" id="current-xp">0 XP</div>
                <div class="footer-buttons">
                    <button id="view-analytics-btn" class="footer-btn"> Progress</button>
                    <button id="open-settings-btn" class="footer-btn"> Settings</button>
                    <button class="btn-back-to-profile" id="back-to-profile-btn"> Back</button>
                </div>
            </div>
        </div>

        <!-- Analytics Screen -->
        <div id="analytics-screen" class="screen">
            <div class="analytics-container">
                <div class="analytics-header">
                    <h1>Your Progress</h1>
                    <button id="back-from-analytics-btn" class="back-btn"> Back</button>
                </div>

                <div class="analytics-content">
                    <!-- Overall Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Overall Accuracy</div>
                            <div class="stat-value" id="accuracy-display">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Study Streak</div>
                            <div class="stat-value" id="streak-display">0 days</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Cards Studied</div>
                            <div class="stat-value" id="cards-studied-display">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Study Time</div>
                            <div class="stat-value" id="study-time-display">0 min</div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="charts-section">
                        <div class="chart-container">
                            <h3>Difficulty Distribution</h3>
                            <canvas id="difficulty-chart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Accuracy Trend</h3>
                            <canvas id="accuracy-trend-chart"></canvas>
                        </div>
                    </div>

                    <!-- Top Struggled Cards -->
                    <div class="struggled-cards-section">
                        <h3>Top 10 Struggled Cards</h3>
                        <div class="struggled-cards-list" id="struggled-cards-list">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settings-screen" class="screen">
            <div class="settings-container">
                <div class="settings-header">
                    <h1>Settings</h1>
                    <button id="back-from-settings-btn" class="back-btn"> Back</button>
                </div>

                <div class="settings-content">
                    <!-- Account Info -->
                    <div class="settings-section">
                        <h2>Account Information</h2>
                        <div class="info-row">
                            <span class="label">Username:</span>
                            <span class="value" id="settings-username">-</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Account Created:</span>
                            <span class="value" id="settings-created">-</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Total XP:</span>
                            <span class="value" id="settings-xp">-</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Current Level:</span>
                            <span class="value" id="settings-level">-</span>
                        </div>
                    </div>

                    <!-- Change PIN -->
                    <div class="settings-section">
                        <h2>Change PIN</h2>
                        <form id="change-pin-form">
                            <div class="form-group">
                                <label for="current-pin">Current PIN:</label>
                                <input type="password" id="current-pin" placeholder="4 digits" maxlength="4" inputmode="numeric" required>
                            </div>
                            <div class="form-group">
                                <label for="new-pin">New PIN:</label>
                                <input type="password" id="new-pin" placeholder="4 digits" maxlength="4" inputmode="numeric" required>
                            </div>
                            <div class="form-group">
                                <label for="confirm-pin">Confirm PIN:</label>
                                <input type="password" id="confirm-pin" placeholder="4 digits" maxlength="4" inputmode="numeric" required>
                            </div>
                            <button type="submit" class="form-btn">Change PIN</button>
                            <div id="pin-error-msg" class="error-message"></div>
                        </form>
                    </div>

                    <!-- Preferences -->
                    <div class="settings-section">
                        <h2>Study Preferences</h2>
                        <div class="form-group">
                            <label for="daily-goal">Daily Study Goal (cards):</label>
                            <input type="number" id="daily-goal" min="1" max="500" value="50">
                        </div>
                        <div class="form-group checkbox">
                            <label for="notifications-enabled">
                                <input type="checkbox" id="notifications-enabled">
                                Enable Notifications
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="cards-per-session">Cards Per Session (0 = unlimited):</label>
                            <input type="number" id="cards-per-session" min="0" max="500" value="0">
                        </div>
                        <button id="save-preferences-btn" class="form-btn">Save Preferences</button>
                    </div>

                    <!-- Admin Access (only for admins) -->
                    <div class="settings-section" id="admin-access-section" style="display: none;">
                        <button id="access-admin-btn" class="form-btn">Admin Dashboard</button>
                    </div>

                    <!-- Logout -->
                    <div class="settings-section">
                        <button id="logout-from-settings-btn" class="logout-btn">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-screen" class="screen">
            <div class="admin-container">
                <div class="admin-header">
                    <button id="back-from-admin-btn" class="back-btn"> Back</button>
                    <h1>Admin Dashboard</h1>
                    <button id="admin-logout-btn" class="back-btn">Logout</button>
                </div>

                <div class="admin-content">
                    <!-- Card Management Section -->
                    <div class="card-management-section">
                        <h2>Manage Product Cards</h2>
                        <div class="card-management-actions">
                            <button id="upload-cards-btn" class="action-btn"> Upload Card File</button>
                            <input type="file" id="card-file-input" accept=".csv" style="display: none;">
                        </div>

                        <!-- Upload Modal -->
                        <div id="upload-modal" class="modal" style="display: none;">
                            <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                                <span class="close-modal">&times;</span>
                                <h2>Upload Card File</h2>

                                <!-- File Selection -->
                                <div id="file-selection-step" class="upload-step">
                                    <h3>Step 1: Select CSV File</h3>
                                    <div class="file-drop-area" id="file-drop-area">
                                        <p> Drag and drop CSV file here or click to select</p>
                                    </div>
                                    <button id="select-file-btn" class="form-btn">Select File</button>
                                </div>

                                <!-- Validation Results -->
                                <div id="validation-step" class="upload-step" style="display: none;">
                                    <h3>Step 2: Validation Results</h3>
                                    <div id="validation-messages" class="validation-output">
                                        <!-- Messages will appear here -->
                                    </div>
                                    <div id="csv-preview" class="csv-preview">
                                        <!-- Preview will appear here -->
                                    </div>
                                </div>

                                <!-- Category Selection -->
                                <div id="category-step" class="upload-step" style="display: none;">
                                    <h3>Step 3: Select Category</h3>
                                    <div class="form-group">
                                        <label for="card-category">Product Category:</label>
                                        <select id="card-category" class="form-control">
                                            <option value="">-- Loading categories... --</option>
                                        </select>
                                        <small>Select the product category these cards belong to</small>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="upload-actions">
                                    <button id="validate-csv-btn" class="form-btn" style="display: none;">Validate CSV</button>
                                    <button id="upload-cards-confirm-btn" class="form-btn" style="display: none;">Upload Cards</button>
                                    <button id="cancel-upload-btn" class="form-btn secondary">Cancel</button>
                                </div>

                                <div id="upload-status" class="status-message"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Management Section -->
                    <div class="card-management-section" style="margin-top: 30px; border-top: 2px solid rgba(255,255,255,0.2); padding-top: 20px;">
                        <h2>Manage Cards</h2>
                        <div class="form-group">
                            <label for="card-set-selector-admin">Select Card Set to Edit or Delete:</label>
                            <select id="card-set-selector-admin" class="form-control">
                                <option value="">-- Choose a card set --</option>
                            </select>
                        </div>

                        <!-- Card Set Actions -->
                        <div class="card-management-actions" style="margin-top: 15px; margin-bottom: 15px;">
                            <button id="delete-card-set-btn" class="action-btn" style="background: rgba(220, 53, 69, 0.8); border: 1px solid rgba(220, 53, 69, 1); display: none;"> Delete This Card Set</button>
                        </div>

                        <!-- Cards List Container -->
                        <div id="cards-list-container" style="margin-top: 15px; display: none;">
                            <div id="cards-list" style="background: rgba(0,0,0,0.3); border-radius: 8px; max-height: 400px; overflow-y: auto;">
                                <!-- Cards will be rendered here -->
                            </div>
                        </div>

                        <!-- Edit Card Modal -->
                        <div id="edit-card-modal" class="modal" style="display: none;">
                            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                                <span class="close-modal">&times;</span>
                                <h2>Edit Card</h2>

                                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                    <!-- Card Preview -->
                                    <h3 style="margin-top: 0; color: #FFD700;">Card Preview</h3>
                                    <div id="card-preview" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px; min-height: 80px;">
                                        <p style="color: rgba(255,255,255,0.7); margin: 0;"><em>Preview will appear here as you edit...</em></p>
                                    </div>
                                </div>

                                <!-- Card Question Editor -->
                                <div class="form-group">
                                    <label for="edit-card-question">Question (with fill-in-the-blank fields):</label>
                                    <textarea id="edit-card-question" class="form-control" placeholder="e.g., The flavor is {{c1::Blueberry}} from {{c2::Japan}}" rows="3" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.3); color: white; font-family: inherit;"></textarea>
                                    <small style="color: rgba(255,255,255,0.7);">Use format: {{c1::answer}}, {{c2::answer}}, etc. (2-5 fields required)</small>
                                    <div id="cloze-errors" style="margin-top: 8px;"></div>
                                </div>

                                <!-- Cloze Fields Editor -->
                                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <h3 style="margin-top: 0; margin-bottom: 15px; color: #FFD700;">Fill-in-the-Blank Fields</h3>
                                    <div id="cloze-fields-list" style="display: none;">
                                        <!-- Cloze fields will be rendered here -->
                                    </div>
                                    <div id="no-cloze-fields" style="color: rgba(255,255,255,0.6); padding: 15px; text-align: center; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                        <p>No cloze fields detected in question</p>
                                    </div>
                                </div>

                                <!-- Card Answer -->
                                <div class="form-group">
                                    <label for="edit-card-answer">Answer/Back (Optional):</label>
                                    <input type="text" id="edit-card-answer" class="form-control" placeholder="e.g., Blue Raspberry Flavor from Asia" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.3); color: white; font-family: inherit;">
                                </div>

                                <!-- Card Category -->
                                <div class="form-group">
                                    <label for="edit-card-category">Category (Optional):</label>
                                    <input type="text" id="edit-card-category" class="form-control" placeholder="e.g., Flavors" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.3); color: white; font-family: inherit;">
                                </div>

                                <!-- Card Tags -->
                                <div class="form-group">
                                    <label for="edit-card-tags">Tags (Optional, comma-separated):</label>
                                    <input type="text" id="edit-card-tags" class="form-control" placeholder="e.g., blue, flavor, sweet" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.3); color: white; font-family: inherit;">
                                </div>

                                <!-- Action Buttons -->
                                <div class="form-group" style="display: flex; gap: 10px; margin-top: 20px;">
                                    <button id="save-card-btn" class="form-btn">Save Changes</button>
                                    <button id="delete-card-btn" class="form-btn secondary" style="background-color: rgba(220, 53, 69, 0.7); border-color: #dc3545;">Delete Card</button>
                                    <button type="button" class="form-btn secondary" onclick="document.getElementById('edit-card-modal').style.display='none'">Cancel</button>
                                </div>

                                <div id="edit-status" class="status-message" style="margin-top: 15px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Category Management Section -->
                    <div class="card-management-section" style="margin-top: 30px; border-top: 2px solid rgba(255,255,255,0.2); padding-top: 20px;">
                        <h2>Manage Categories</h2>
                        <div class="card-management-actions">
                            <button id="create-category-btn" class="action-btn">+ Create Category</button>
                        </div>

                        <!-- Categories List -->
                        <div class="categories-list-container" style="margin-top: 15px;">
                            <div id="categories-loading" style="color: rgba(255,255,255,0.7); padding: 15px; text-align: center;">Loading categories...</div>
                            <div id="categories-list" style="display: none;">
                                <!-- Categories will be rendered here -->
                            </div>
                        </div>

                        <!-- Create Category Modal -->
                        <div id="category-modal" class="modal" style="display: none;">
                            <div class="modal-content" style="max-width: 500px;">
                                <span class="close-modal">&times;</span>
                                <h2 id="category-modal-title">Create Category</h2>
                                <form id="category-form">
                                    <div class="form-group">
                                        <label for="category-name">Category Name:</label>
                                        <input type="text" id="category-name" placeholder="e.g., Disposable Vapes" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="category-id">Category ID:</label>
                                        <input type="text" id="category-id" placeholder="e.g., disposable-vapes (auto-generated)" readonly>
                                        <small>Auto-generated from category name. Lowercase, hyphens only.</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="category-description">Description (Optional):</label>
                                        <textarea id="category-description" placeholder="Brief description of this category" rows="3" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.3); color: white; font-family: inherit;"></textarea>
                                    </div>
                                    <div class="form-group" style="display: flex; gap: 10px;">
                                        <button type="submit" class="form-btn" id="category-submit-btn">Create Category</button>
                                        <button type="button" class="form-btn secondary" onclick="document.getElementById('category-modal').style.display='none'">Cancel</button>
                                    </div>
                                    <div id="category-status" class="status-message" style="margin-top: 10px;"></div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Actions -->
                    <div class="admin-actions">
                        <button id="create-admin-btn" class="action-btn">+ Create Admin</button>
                        <input type="text" id="user-search" placeholder="Search users..." class="search-input">
                    </div>

                    <!-- User List -->
                    <div class="users-list-container">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Level</th>
                                    <th>XP</th>
                                    <th>Accuracy</th>
                                    <th>Last Active</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr><td colspan="6">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Create Admin Modal -->
                    <div id="admin-modal" class="modal" style="display: none;">
                        <div class="modal-content">
                            <span class="close-modal">&times;</span>
                            <h2>Create Admin Account</h2>
                            <form id="create-admin-form">
                                <div class="form-group">
                                    <label for="admin-username">Username:</label>
                                    <input type="text" id="admin-username" placeholder="2-20 characters" minlength="2" maxlength="20" required>
                                </div>
                                <div class="form-group">
                                    <label for="admin-pin">PIN:</label>
                                    <input type="password" id="admin-pin" placeholder="4 digits" maxlength="4" inputmode="numeric" required>
                                </div>
                                <div class="form-group">
                                    <label for="admin-confirm-pin">Confirm PIN:</label>
                                    <input type="password" id="admin-confirm-pin" placeholder="4 digits" maxlength="4" inputmode="numeric" required>
                                </div>
                                <button type="submit" class="form-btn">Create Admin</button>
                                <div id="admin-error-msg" class="error-message"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="answer-validation.js"></script>
    <script src="profile-system.js"></script>
    <script src="load-cards.js"></script>
    <script src="validate-csv.js"></script>
    <script>
        // ====================================================
        // JUICE FLASHCARD WEB APP
        // ====================================================

        class JuiceFlashcardApp {
            constructor() {
                this.profiles = [];
                this.currentProfile = null;
                this.cards = [];
                this.currentCardIndex = 0;
                this.sessionStartTime = null;

                this.initElements();
                this.attachEventListeners();
                this.initializeApp();
            }

            async initializeApp() {
                // Initialize Firebase
                const fbInitialized = await window.JuiceAuth.initializeFirebase();

                if (!fbInitialized) {
                    console.warn('Firebase initialization failed, continuing with offline mode');
                }

                // Hide category selection modal on startup
                const categoryModal = document.getElementById('category-selection-modal');
                if (categoryModal) {
                    categoryModal.style.display = 'none';
                }

                // Check if user is logged in
                const session = window.JuiceAuth.getCurrentSession();
                if (session) {
                    // User is logged in, load their data and go straight to study
                    await this.loadData();
                    this.ensureUserProfile(session.username);
                    this.startSession();
                } else {
                    // User not logged in, show login screen
                    this.showLoginScreen();
                }
            }

            initElements() {
                // Profile screen
                this.profileScreen = document.getElementById('profile-screen');
                this.studyScreen = document.getElementById('study-screen');
                this.profileList = document.getElementById('profile-list');
                this.profileNameInput = document.getElementById('profile-name-input');
                this.createProfileBtn = document.getElementById('create-profile-btn');

                // Study screen
                this.flipCardContainer = document.querySelector('.flip-card-container');
                this.flipCard = document.getElementById('flip-card');
                this.frontCloze = document.getElementById('front-cloze');
                this.backCloze = document.getElementById('back-cloze');
                this.userAnswerInput = document.getElementById('user-answer-input');
                this.comparisonSection = document.getElementById('comparison-section');
                this.yourAnswerDisplay = document.getElementById('your-answer-display');
                this.expectedAnswerDisplay = document.getElementById('expected-answer-display');
                this.feedbackMessage = document.getElementById('feedback-message');
                this.ratingButtons = document.querySelectorAll('.rating-btn');

                // Footer
                this.currentProfileDisplay = document.getElementById('current-profile');
                this.currentLevelDisplay = document.getElementById('current-level');
                this.currentXpDisplay = document.getElementById('current-xp');
                this.backToProfileBtn = document.getElementById('back-to-profile-btn');

                // Analytics, Settings, and Admin screens
                this.analyticsScreen = document.getElementById('analytics-screen');
                this.settingsScreen = document.getElementById('settings-screen');
                this.adminScreen = document.getElementById('admin-screen');
            }

            attachEventListeners() {
                // ====== AUTHENTICATION EVENT LISTENERS ======

                // Login button
                const loginBtn = document.getElementById('login-btn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', () => this.handleLogin());
                }

                // Signup button
                const signupBtn = document.getElementById('signup-btn');
                if (signupBtn) {
                    signupBtn.addEventListener('click', () => this.handleSignup());
                }

                // Navigation buttons
                const gotoSignupBtn = document.getElementById('goto-signup-btn');
                if (gotoSignupBtn) {
                    gotoSignupBtn.addEventListener('click', () => this.showSignupScreen());
                }

                const gotoLoginBtn = document.getElementById('goto-login-btn');
                if (gotoLoginBtn) {
                    gotoLoginBtn.addEventListener('click', () => this.showLoginScreen());
                }

                // Enter key in login/signup fields
                const loginUsername = document.getElementById('login-username');
                const loginPin = document.getElementById('login-pin');
                if (loginPin) {
                    loginPin.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.handleLogin();
                    });
                }

                const signupUsername = document.getElementById('signup-username');
                const signupPin = document.getElementById('signup-pin');
                const signupPinConfirm = document.getElementById('signup-pin-confirm');
                if (signupPinConfirm) {
                    signupPinConfirm.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.handleSignup();
                    });
                }

                // Logout button
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => this.handleLogout());
                }

                // ====== END AUTHENTICATION EVENT LISTENERS ======

                // ====== ANALYTICS BUTTON ======
                const viewAnalyticsBtn = document.getElementById('view-analytics-btn');
                if (viewAnalyticsBtn) {
                    viewAnalyticsBtn.addEventListener('click', () => this.showAnalyticsScreen());
                }

                const backFromAnalyticsBtn = document.getElementById('back-from-analytics-btn');
                if (backFromAnalyticsBtn) {
                    backFromAnalyticsBtn.addEventListener('click', () => this.showStudyScreen());
                }

                // ====== SETTINGS BUTTON ======
                const openSettingsBtn = document.getElementById('open-settings-btn');
                if (openSettingsBtn) {
                    openSettingsBtn.addEventListener('click', () => this.showSettingsScreen());
                }

                const backFromSettingsBtn = document.getElementById('back-from-settings-btn');
                if (backFromSettingsBtn) {
                    backFromSettingsBtn.addEventListener('click', () => this.showStudyScreen());
                }

                // Settings form listeners
                const changePinForm = document.getElementById('change-pin-form');
                if (changePinForm) {
                    changePinForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleChangePIN();
                    });
                }

                const savePreferencesBtn = document.getElementById('save-preferences-btn');
                if (savePreferencesBtn) {
                    savePreferencesBtn.addEventListener('click', () => this.handleSavePreferences());
                }

                const logoutFromSettingsBtn = document.getElementById('logout-from-settings-btn');
                if (logoutFromSettingsBtn) {
                    logoutFromSettingsBtn.addEventListener('click', () => this.handleLogout());
                }

                const accessAdminBtn = document.getElementById('access-admin-btn');
                if (accessAdminBtn) {
                    accessAdminBtn.addEventListener('click', () => this.showAdminScreen());
                }

                // ====== ADMIN BUTTONS ======
                const createAdminBtn = document.getElementById('create-admin-btn');
                if (createAdminBtn) {
                    createAdminBtn.addEventListener('click', () => this.showAdminModal());
                }

                // ====== CARD UPLOAD BUTTONS ======
                const uploadCardsBtn = document.getElementById('upload-cards-btn');
                if (uploadCardsBtn) {
                    uploadCardsBtn.addEventListener('click', () => this.showUploadModal());
                }

                const cardFileInput = document.getElementById('card-file-input');
                if (cardFileInput) {
                    cardFileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                }

                const selectFileBtn = document.getElementById('select-file-btn');
                if (selectFileBtn) {
                    selectFileBtn.addEventListener('click', () => {
                        document.getElementById('card-file-input').click();
                    });
                }

                const fileDropArea = document.getElementById('file-drop-area');
                if (fileDropArea) {
                    fileDropArea.addEventListener('click', () => {
                        document.getElementById('card-file-input').click();
                    });
                    fileDropArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        fileDropArea.classList.add('dragover');
                    });
                    fileDropArea.addEventListener('dragleave', () => {
                        fileDropArea.classList.remove('dragover');
                    });
                    fileDropArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        fileDropArea.classList.remove('dragover');
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            this.handleFileDrop(files[0]);
                        }
                    });
                }

                const validateCsvBtn = document.getElementById('validate-csv-btn');
                if (validateCsvBtn) {
                    validateCsvBtn.addEventListener('click', () => this.validateUploadedCSV());
                }

                const uploadCardsConfirmBtn = document.getElementById('upload-cards-confirm-btn');
                if (uploadCardsConfirmBtn) {
                    uploadCardsConfirmBtn.addEventListener('click', () => this.confirmUploadCards());
                }

                const cancelUploadBtn = document.getElementById('cancel-upload-btn');
                if (cancelUploadBtn) {
                    cancelUploadBtn.addEventListener('click', () => this.closeUploadModal());
                }

                const closeModalBtn = document.querySelector('.close-modal');
                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', () => {
                        this.closeAdminModal();
                        this.closeUploadModal();
                    });
                }

                const createAdminForm = document.getElementById('create-admin-form');
                if (createAdminForm) {
                    createAdminForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleCreateAdmin();
                    });
                }

                const backFromAdminBtn = document.getElementById('back-from-admin-btn');
                if (backFromAdminBtn) {
                    backFromAdminBtn.addEventListener('click', () => this.handleAdminBackButton());
                }

                const adminLogoutBtn = document.getElementById('admin-logout-btn');
                if (adminLogoutBtn) {
                    adminLogoutBtn.addEventListener('click', () => this.handleLogout());
                }

                this.createProfileBtn.addEventListener('click', () => this.createNewProfile());
                this.profileNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.createNewProfile();
                });

                // Card set selector listener
                const cardSetSelector = document.getElementById('card-set-selector');
                if (cardSetSelector) {
                    cardSetSelector.addEventListener('change', (e) => this.handleCardSetSelection(e.target.value));
                }

                // Category selection modal listeners
                const categoryConfirmBtn = document.getElementById('category-confirm-btn');
                if (categoryConfirmBtn) {
                    categoryConfirmBtn.addEventListener('click', () => this.handleCategorySelectionConfirm());
                }

                const categoryLogoutBtn = document.getElementById('category-logout-btn');
                if (categoryLogoutBtn) {
                    categoryLogoutBtn.addEventListener('click', () => this.handleLogout());
                }

                // Don't load card sets on init - they're loaded in the modal after login
                // this.loadAvailableCardSets();

                // Category management listeners
                const createCategoryBtn = document.getElementById('create-category-btn');
                if (createCategoryBtn) {
                    createCategoryBtn.addEventListener('click', () => this.openCategoryModal());
                }

                const categoryForm = document.getElementById('category-form');
                if (categoryForm) {
                    categoryForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleCategoryFormSubmit();
                    });
                }

                const categoryNameInput = document.getElementById('category-name');
                if (categoryNameInput) {
                    categoryNameInput.addEventListener('input', (e) => this.updateCategoryId(e.target.value));
                }

                const categoryModalCloseBtn = document.querySelector('#category-modal .close-modal');
                if (categoryModalCloseBtn) {
                    categoryModalCloseBtn.addEventListener('click', () => this.closeCategoryModal());
                }

                // Load categories on initialization (will be called again in showAdminScreen)
                // this.loadCategoriesList();

                // Card management listeners
                const cardSetSelectorAdmin = document.getElementById('card-set-selector-admin');
                if (cardSetSelectorAdmin) {
                    cardSetSelectorAdmin.addEventListener('change', (e) => this.handleCardSetSelectionForEditing(e.target.value));
                    // Load card sets will be called in showAdminScreen after Firebase is ready
                }

                const editCardQuestionInput = document.getElementById('edit-card-question');
                if (editCardQuestionInput) {
                    editCardQuestionInput.addEventListener('input', () => this.updateCardPreview());
                }

                const saveCardBtn = document.getElementById('save-card-btn');
                if (saveCardBtn) {
                    saveCardBtn.addEventListener('click', () => this.handleSaveCard());
                }

                const deleteCardBtn = document.getElementById('delete-card-btn');
                if (deleteCardBtn) {
                    deleteCardBtn.addEventListener('click', () => this.handleDeleteCard());
                }

                const deleteCardSetBtn = document.getElementById('delete-card-set-btn');
                if (deleteCardSetBtn) {
                    deleteCardSetBtn.addEventListener('click', () => this.handleDeleteCardSet());
                }

                const editCardModalCloseBtn = document.querySelector('#edit-card-modal .close-modal');
                if (editCardModalCloseBtn) {
                    editCardModalCloseBtn.addEventListener('click', () => this.closeEditCardModal());
                }

                // Check Answer button listener
                const checkAnswerBtn = document.getElementById('check-answer-btn');
                if (checkAnswerBtn) {
                    checkAnswerBtn.addEventListener('click', () => this.toggleFlip());
                }

                // Enter key in input field
                this.userAnswerInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.toggleFlip();
                    }
                });

                this.ratingButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const rating = e.currentTarget.getAttribute('data-rating');
                        this.submitRating(rating);
                    });
                });

                // Keyboard shortcuts for rating: 1=Again, 2=Hard, 3=Good, 4=Easy
                document.addEventListener('keypress', (e) => {
                    // Only handle if we're on the study screen and have rating buttons visible
                    if (!this.studyScreen.classList.contains('active')) {
                        return;
                    }

                    // Check if comparison section is visible (meaning we're on the back card)
                    if (!this.comparisonSection.classList.contains('show')) {
                        return;
                    }

                    let rating = null;
                    if (e.key === '1') {
                        rating = 'again';
                    } else if (e.key === '2') {
                        rating = 'hard';
                    } else if (e.key === '3') {
                        rating = 'good';
                    } else if (e.key === '4') {
                        rating = 'easy';
                    }

                    if (rating) {
                        e.preventDefault();
                        this.submitRating(rating);
                    }
                });

                this.backToProfileBtn.addEventListener('click', () => this.endSession());
            }

            async loadData() {
                // Load profiles from localStorage first
                try {
                    this.profiles = JSON.parse(localStorage.getItem('juice_profiles')) || [];
                } catch (e) {
                    this.profiles = [];
                }

                // Sync profiles from cloud
                const session = window.JuiceAuth.getCurrentSession();
                if (session) {
                    try {
                        await window.JuiceAuth.syncProfilesFromCloud(session.username);
                        // After cloud sync, reload profiles from localStorage (they've been merged)
                        this.profiles = JSON.parse(localStorage.getItem('juice_profiles')) || [];
                    } catch (e) {
                        console.warn('Could not sync profiles from cloud:', e);
                    }

                    // Sync pending card ratings (made while offline)
                    if (this.profiles.length > 0) {
                        const currentProfileId = localStorage.getItem('juice_current_profile');
                        if (currentProfileId) {
                            try {
                                const syncResult = await window.JuiceAuth.syncPendingRatings(session.username, currentProfileId);
                                if (syncResult.synced > 0) {
                                    console.log(`Synced ${syncResult.synced} pending card ratings`);
                                }
                            } catch (e) {
                                console.warn('Could not sync pending ratings:', e);
                            }
                        }
                    }
                }

                // Load cards from CSV
                this.loadCardsFromCSV();
            }

            loadCardsFromCSV() {
                try {
                    // DO NOT auto-load cards from localStorage
                    // Users must select a category from the dropdown
                    // This prevents test cards from auto-appearing
                    this.cards = [];
                    console.log('Cards will be loaded from category dropdown. Use "Select Study Material" to choose cards.');
                } catch (e) {
                    console.error('Error loading cards:', e);
                    this.cards = [];
                }
            }

            async loadCardsFromFile() {
                try {
                    const response = await fetch('juice_cloze_import_UPDATED.csv');
                    if (!response.ok) {
                        alert('Error: Could not load CSV file. Make sure juice_cloze_import_UPDATED.csv is in the same folder as index.html');
                        return;
                    }
                    const csvText = await response.text();
                    const cards = this.parseCSV(csvText);

                    if (cards.length === 0) {
                        alert('Error: CSV file is empty or invalid format');
                        return;
                    }

                    localStorage.setItem('juice_cards', JSON.stringify(cards));
                    this.cards = cards;
                    alert(` Loaded ${cards.length} cards!\n\nCards are ready to study.`);
                    this.renderProfileList();
                } catch (error) {
                    console.error('Error loading cards:', error);
                    alert('Error loading CSV file. Check console for details.');
                }
            }

            parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) return [];

                const cards = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split('\t');
                    if (values.length < 2 || !values[0]) continue;

                    const card = {
                        id: i.toString(),
                        text: values[0] || '',
                        name: values[1] || '',
                        category: values[2] || '',
                        difficulty: values[3] || '',
                        notes: values[4] || ''
                    };

                    // Only include if it has cloze format
                    if (card.text.includes('{{c')) {
                        cards.push(card);
                    }
                }

                return cards;
            }

            // ====== HELPER METHODS ======
            hideAllScreens() {
                document.getElementById('login-screen').classList.remove('active');
                document.getElementById('signup-screen').classList.remove('active');
                document.getElementById('profile-screen').classList.remove('active');
                document.getElementById('study-screen').classList.remove('active');
                document.getElementById('analytics-screen').classList.remove('active');
                document.getElementById('settings-screen').classList.remove('active');
                document.getElementById('admin-screen').classList.remove('active');
            }

            // ====== AUTHENTICATION METHODS ======

            showLoginScreen() {
                this.hideAllScreens();
                document.getElementById('login-screen').classList.add('active');
                document.getElementById('login-error').classList.remove('show');
                document.getElementById('login-username').value = '';
                document.getElementById('login-pin').value = '';
                setTimeout(() => document.getElementById('login-username').focus(), 300);
            }

            showSignupScreen() {
                this.hideAllScreens();
                document.getElementById('signup-screen').classList.add('active');
                document.getElementById('signup-error').classList.remove('show');
                document.getElementById('signup-username').value = '';
                document.getElementById('signup-pin').value = '';
                document.getElementById('signup-pin-confirm').value = '';
                setTimeout(() => document.getElementById('signup-username').focus(), 300);
            }

            async handleLogin() {
                const username = document.getElementById('login-username').value.trim();
                const pin = document.getElementById('login-pin').value.trim();
                const errorDiv = document.getElementById('login-error');

                if (!username || !pin) {
                    this.showError(errorDiv, 'Please enter both username and PIN');
                    return;
                }

                if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                    this.showError(errorDiv, 'PIN must be exactly 4 digits');
                    return;
                }

                try {
                    errorDiv.classList.remove('show');
                    const loginBtn = document.getElementById('login-btn');
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'Signing in...';

                    const result = await window.JuiceAuth.signIn(username, pin);

                    if (result.success) {
                        // Cache the session
                        sessionStorage.setItem('juiceUser', JSON.stringify({
                            username: result.username,
                            userId: result.userId
                        }));

                        // Check if user is admin
                        const isAdmin = await window.JuiceAuth.isUserAdmin(result.username);

                        if (isAdmin) {
                            // Admin users go directly to admin dashboard
                            this.currentUsername = result.username;
                            this.showAdminScreen();
                        } else {
                            // Regular users go to profile/learning screen
                            // Load profiles from cloud
                            await this.loadData();
                            // Auto-select or create the single profile
                            this.ensureUserProfile(result.username);
                            this.startSession();
                        }
                    } else {
                        this.showError(errorDiv, result.error || 'Sign in failed');
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Sign In';
                    }
                } catch (error) {
                    this.showError(errorDiv, 'Sign in error: ' + error.message);
                    document.getElementById('login-btn').disabled = false;
                    document.getElementById('login-btn').textContent = 'Sign In';
                }
            }

            async handleSignup() {
                const username = document.getElementById('signup-username').value.trim();
                const pin = document.getElementById('signup-pin').value.trim();
                const pinConfirm = document.getElementById('signup-pin-confirm').value.trim();
                const errorDiv = document.getElementById('signup-error');

                if (!username || !pin || !pinConfirm) {
                    this.showError(errorDiv, 'Please fill in all fields');
                    return;
                }

                if (username.length < 2 || username.length > 20) {
                    this.showError(errorDiv, 'Username must be 2-20 characters');
                    return;
                }

                if (!/^[a-z0-9]+$/i.test(username)) {
                    this.showError(errorDiv, 'Username must be alphanumeric only');
                    return;
                }

                if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                    this.showError(errorDiv, 'PIN must be exactly 4 digits');
                    return;
                }

                if (pin !== pinConfirm) {
                    this.showError(errorDiv, 'PIN confirmation does not match');
                    return;
                }

                try {
                    errorDiv.classList.remove('show');
                    const signupBtn = document.getElementById('signup-btn');
                    signupBtn.disabled = true;
                    signupBtn.textContent = 'Creating account...';

                    const result = await window.JuiceAuth.signUp(username, pin);

                    if (result.success) {
                        // Cache the session
                        sessionStorage.setItem('juiceUser', JSON.stringify({
                            username: result.username,
                            userId: result.userId
                        }));
                        // Load profiles from cloud (or create empty array for new accounts)
                        await this.loadData();
                        // Auto-create the single profile for new account
                        this.ensureUserProfile(result.username);
                        this.startSession();
                    } else {
                        this.showError(errorDiv, result.error || 'Sign up failed');
                        signupBtn.disabled = false;
                        signupBtn.textContent = 'Sign Up';
                    }
                } catch (error) {
                    this.showError(errorDiv, 'Sign up error: ' + error.message);
                    document.getElementById('signup-btn').disabled = false;
                    document.getElementById('signup-btn').textContent = 'Sign Up';
                }
            }

            showError(errorDiv, message) {
                errorDiv.textContent = message;
                errorDiv.classList.add('show');
            }

            async handleLogout() {
                try {
                    // Save profiles to cloud before logout
                    if (this.profiles.length > 0) {
                        await window.JuiceAuth.saveProfilesToCloud(this.profiles);
                    }

                    // Clear session
                    await window.JuiceAuth.signOut();
                    sessionStorage.removeItem('juiceUser');

                    // Show login screen
                    this.showLoginScreen();
                } catch (error) {
                    console.error('Logout error:', error);
                    // Force logout anyway
                    sessionStorage.removeItem('juiceUser');
                    this.showLoginScreen();
                }
            }

            // ====== END AUTHENTICATION METHODS ======

            ensureUserProfile(username) {
                // Get or create a single profile for the user
                if (this.profiles.length === 0) {
                    // Create a default profile using the username
                    const newProfile = {
                        id: Date.now().toString(),
                        name: username,
                        xp: 0,
                        currentLevel: 1,
                        totalCards: 0,
                        correctCards: 0,
                        createdAt: new Date().toISOString()
                    };
                    this.profiles.push(newProfile);
                    this.saveProfiles();
                }

                // Set current profile to the first (and only) profile
                this.currentProfile = this.profiles[0];
            }

            async loadCardDifficulties() {
                // Load card difficulty ratings from Firestore
                this.cardDifficulties = {}; // Reset

                const session = window.JuiceAuth.getCurrentSession();
                if (!session || !this.currentProfile) {
                    // Default all cards to Medium difficulty if not logged in
                    this.cards.forEach(card => {
                        this.cardDifficulties[card.id] = 'Medium';
                    });
                    return;
                }

                try {
                    // Load from Firestore
                    const cardHistories = await window.JuiceAuth.loadCardHistories(
                        session.username,
                        this.currentProfile.id
                    );

                    // Build difficulty map
                    this.cards.forEach(card => {
                        if (cardHistories && cardHistories[card.id]) {
                            this.cardDifficulties[card.id] = cardHistories[card.id].difficulty;
                        } else {
                            this.cardDifficulties[card.id] = 'Medium'; // Default for unrated
                        }
                    });

                    // Cache to localStorage as backup
                    localStorage.setItem('juice_card_difficulties_' + this.currentProfile.id, JSON.stringify(this.cardDifficulties));
                } catch (error) {
                    console.warn('Could not load card difficulties from cloud, using localStorage:', error);
                    // Try localStorage backup
                    const cached = localStorage.getItem('juice_card_difficulties_' + this.currentProfile.id);
                    if (cached) {
                        this.cardDifficulties = JSON.parse(cached);
                    } else {
                        // Fallback: all Medium
                        this.cards.forEach(card => {
                            this.cardDifficulties[card.id] = 'Medium';
                        });
                    }
                }
            }

            buildWeightedDeck() {
                // Create a weighted pool of card indices based on difficulty
                const weightedPool = [];

                const weights = {
                    'Again': 4,
                    'Hard': 2.5,
                    'Medium': 1,
                    'Good': 0.5,
                    'Easy': 0.25
                };

                // Add each card to the pool based on its difficulty weight
                this.cards.forEach((card, index) => {
                    const difficulty = this.cardDifficulties[card.id] || 'Medium';
                    const weight = weights[difficulty] || 1;

                    // Add card index to pool according to weight
                    // For fractional weights, use randomization
                    const baseCount = Math.floor(weight);
                    const fractional = weight - baseCount;

                    // Add base count copies
                    for (let i = 0; i < baseCount; i++) {
                        weightedPool.push(index);
                    }

                    // For fractional part, randomly decide whether to add extra copy
                    if (fractional > 0 && Math.random() < fractional) {
                        weightedPool.push(index);
                    }
                });

                // Fisher-Yates shuffle of weighted pool
                for (let i = weightedPool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [weightedPool[i], weightedPool[j]] = [weightedPool[j], weightedPool[i]];
                }

                // Create new cards array in shuffled order
                const shuffledCards = [];
                const seenIndices = new Set();

                // Add cards in weighted shuffled order, avoiding duplicates
                for (const index of weightedPool) {
                    if (!seenIndices.has(index)) {
                        shuffledCards.push(this.cards[index]);
                        seenIndices.add(index);
                    }
                }

                // If some cards weren't included due to low weights, add them at the end
                for (let i = 0; i < this.cards.length; i++) {
                    if (!seenIndices.has(i)) {
                        shuffledCards.push(this.cards[i]);
                    }
                }

                return shuffledCards;
            }

            showProfileScreen() {
                this.hideAllScreens();
                this.profileScreen.classList.add('active');
                this.renderProfileList();
                this.profileNameInput.value = '';
                setTimeout(() => this.profileNameInput.focus(), 300);
            }

            renderProfileList() {
                this.profileList.innerHTML = '';
                this.profiles.forEach(profile => {
                    const btn = document.createElement('button');
                    btn.className = 'profile-btn';
                    btn.innerHTML = `
                        <div>${profile.name}</div>
                        <div class="profile-stats">Level ${profile.currentLevel}  ${profile.xp} XP  ${profile.totalCards || 0} cards</div>
                    `;
                    btn.addEventListener('click', () => this.selectProfile(profile.id));
                    this.profileList.appendChild(btn);
                });
            }

            async loadAvailableCardSets() {
                try {
                    const cardSets = await window.JuiceAuth.getCardSets();
                    const selector = document.getElementById('card-set-selector');

                    if (!selector) return;

                    // Clear existing options
                    selector.innerHTML = '<option value="">-- Select Study Material --</option>';

                    // Add each card set as an option
                    cardSets.forEach(set => {
                        const option = document.createElement('option');
                        option.value = set.setId;
                        option.textContent = `${set.name} (${set.cardCount} cards)`;
                        selector.appendChild(option);
                    });

                    // If there are card sets and one is selected, restore it
                    if (this.currentProfile && this.currentProfile.selectedCardSet) {
                        selector.value = this.currentProfile.selectedCardSet;
                    }

                    console.log(`Loaded ${cardSets.length} card sets`);
                } catch (error) {
                    console.error('Error loading card sets:', error);
                    const selector = document.getElementById('card-set-selector');
                    if (selector) {
                        selector.innerHTML = '<option value="">No card sets available</option>';
                    }
                }
            }

            async handleCardSetSelection(setId) {
                if (!setId) {
                    console.log('No card set selected');
                    return;
                }

                try {
                    // Save selected card set to current profile
                    if (this.currentProfile) {
                        this.currentProfile.selectedCardSet = setId;

                        // Also save to localStorage for persistence
                        const key = `profile_${this.currentUsername}_${this.currentProfile.id}`;
                        localStorage.setItem(key, JSON.stringify(this.currentProfile));
                    }

                    // Load the selected card set
                    const cardSets = await window.JuiceAuth.getCardSets();
                    console.log(`Available card sets: ${cardSets.length}`, cardSets);

                    const selectedSet = cardSets.find(s => s.setId === setId);

                    if (selectedSet) {
                        console.log(`Found card set: ${selectedSet.name} (${selectedSet.cardCount} cards)`);
                        // Use the cards from this set
                        this.cards = selectedSet.cards.map(card => ({
                            id: card.id,
                            text: card.question,  // Store question as 'text' for cloze processing
                            answer: card.answer,
                            category: card.category,
                            tags: card.tags,
                            difficulty: card.difficulty || 'Medium'
                        }));

                        console.log(`Loaded ${this.cards.length} cards from "${selectedSet.name}"`);
                    } else {
                        console.warn(`Card set "${setId}" not found in Firestore. Available sets:`, cardSets.map(s => s.setId));
                    }
                } catch (error) {
                    console.error('Error loading card set:', error);
                    alert('Failed to load card set. Using cached cards if available.');
                }
            }

            // ====== CATEGORY SELECTION MODAL ======

            async showCategorySelectionModal() {
                const modal = document.getElementById('category-selection-modal');
                const dropdown = document.getElementById('category-selection-dropdown');

                // Show the modal immediately so user doesn't see blank screen
                modal.style.display = 'flex';

                // Load available card sets with timeout
                try {
                    console.log('Attempting to load card sets from Firestore...');

                    // Create a timeout promise
                    const timeoutPromise = new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('Timeout loading card sets')), 5000)
                    );

                    const cardSets = await Promise.race([
                        window.JuiceAuth.getCardSets(),
                        timeoutPromise
                    ]);

                    console.log(`Loaded ${cardSets.length} card sets`);
                    dropdown.innerHTML = '<option value="">-- Select a Category --</option>';

                    if (cardSets.length === 0) {
                        dropdown.innerHTML += '<option disabled>No categories available</option>';
                    } else {
                        cardSets.forEach(set => {
                            const option = document.createElement('option');
                            option.value = set.setId;
                            option.textContent = `${set.name} (${set.cardCount} cards)`;
                            dropdown.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error loading card sets for modal:', error);
                    dropdown.innerHTML = '<option disabled>Error loading categories: ' + error.message + '</option>';
                }
            }

            hideCategorySelectionModal() {
                const modal = document.getElementById('category-selection-modal');
                modal.style.display = 'none';
            }

            async handleCategorySelectionConfirm() {
                const dropdown = document.getElementById('category-selection-dropdown');
                const selectedSetId = dropdown.value;

                if (!selectedSetId) {
                    alert('Please select a category');
                    return;
                }

                // Load the selected card set
                await this.handleCardSetSelection(selectedSetId);

                // Hide the modal and continue to study
                this.hideCategorySelectionModal();

                // Now start the session with the loaded cards
                await this.loadCardDifficulties();
                this.cards = this.buildWeightedDeck();
                this.sessionStartTime = Date.now();
                this.currentCardIndex = 0;
                this.showStudyScreen();
                this.displayCard();
            }

            // ====== CATEGORY MANAGEMENT METHODS ======

            openCategoryModal(categoryId = null) {
                const modal = document.getElementById('category-modal');
                const form = document.getElementById('category-form');
                const titleEl = document.getElementById('category-modal-title');
                const submitBtn = document.getElementById('category-submit-btn');

                form.reset();
                document.getElementById('category-status').textContent = '';
                document.getElementById('category-name').value = '';
                document.getElementById('category-id').value = '';
                document.getElementById('category-description').value = '';

                if (categoryId) {
                    titleEl.textContent = 'Edit Category';
                    submitBtn.textContent = 'Update Category';
                    form.setAttribute('data-edit-id', categoryId);
                    // Load category data for editing
                    this.loadCategoryForEditing(categoryId);
                } else {
                    titleEl.textContent = 'Create Category';
                    submitBtn.textContent = 'Create Category';
                    form.removeAttribute('data-edit-id');
                }

                modal.style.display = 'block';
            }

            closeCategoryModal() {
                document.getElementById('category-modal').style.display = 'none';
                document.getElementById('category-form').reset();
            }

            updateCategoryId(categoryName) {
                // Convert category name to ID (lowercase, hyphens only)
                const categoryId = categoryName
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');

                document.getElementById('category-id').value = categoryId;
            }

            async loadCategoryForEditing(categoryId) {
                try {
                    const categories = await window.JuiceAuth.getCategories();
                    const category = categories.find(c => c.categoryId === categoryId);

                    if (category) {
                        document.getElementById('category-name').value = category.name;
                        document.getElementById('category-id').value = category.categoryId;
                        document.getElementById('category-description').value = category.description || '';
                    }
                } catch (error) {
                    console.error('Error loading category for editing:', error);
                    document.getElementById('category-status').innerHTML = `<span style="color: #ff6b6b;">Error loading category</span>`;
                }
            }

            async handleCategoryFormSubmit() {
                const categoryName = document.getElementById('category-name').value.trim();
                const categoryId = document.getElementById('category-id').value.trim();
                const categoryDescription = document.getElementById('category-description').value.trim();
                const statusEl = document.getElementById('category-status');
                const form = document.getElementById('category-form');
                const editId = form.getAttribute('data-edit-id');

                if (!categoryName) {
                    statusEl.innerHTML = '<span style="color: #ff6b6b;">Category name is required</span>';
                    return;
                }

                if (!categoryId) {
                    statusEl.innerHTML = '<span style="color: #ff6b6b;">Category ID is required</span>';
                    return;
                }

                try {
                    statusEl.innerHTML = '<span style="color: #4dabf7;">Saving...</span>';

                    if (editId) {
                        // Update existing category
                        await window.JuiceAuth.updateCategory(editId, {
                            name: categoryName,
                            description: categoryDescription
                        });
                        statusEl.innerHTML = '<span style="color: #51cf66;">Category updated successfully!</span>';
                    } else {
                        // Create new category
                        await window.JuiceAuth.saveCategory(categoryId, {
                            name: categoryName,
                            description: categoryDescription,
                            createdBy: this.currentUsername || 'admin'
                        });
                        statusEl.innerHTML = '<span style="color: #51cf66;">Category created successfully!</span>';
                    }

                    // Reload categories list
                    setTimeout(() => {
                        this.loadCategoriesList();
                        this.loadCategoriesDropdown();
                        this.closeCategoryModal();
                    }, 1500);

                } catch (error) {
                    console.error('Error saving category:', error);
                    statusEl.innerHTML = `<span style="color: #ff6b6b;">Error: ${error.message}</span>`;
                }
            }

            async loadCategoriesList() {
                try {
                    const loadingEl = document.getElementById('categories-loading');
                    const listEl = document.getElementById('categories-list');

                    if (!loadingEl || !listEl) return;

                    loadingEl.style.display = 'block';
                    listEl.style.display = 'none';

                    const categories = await window.JuiceAuth.getCategories();

                    if (categories.length === 0) {
                        loadingEl.textContent = 'No categories yet. Create one to get started!';
                        return;
                    }

                    // Render categories
                    this.renderCategoryList(categories);

                    loadingEl.style.display = 'none';
                    listEl.style.display = 'block';

                } catch (error) {
                    console.error('Error loading categories:', error);
                    const loadingEl = document.getElementById('categories-loading');
                    if (loadingEl) {
                        loadingEl.textContent = 'Error loading categories. Please refresh.';
                    }
                }
            }

            renderCategoryList(categories) {
                const listEl = document.getElementById('categories-list');
                if (!listEl) return;

                listEl.innerHTML = '';

                categories.forEach(category => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'category-item';
                    categoryItem.style.cssText = `
                        background: rgba(255,255,255,0.1);
                        padding: 15px;
                        margin-bottom: 10px;
                        border-radius: 6px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        border-left: 4px solid rgba(106, 90, 205, 0.5);
                    `;

                    const infoDiv = document.createElement('div');
                    infoDiv.style.flex = '1';

                    const nameEl = document.createElement('h3');
                    nameEl.textContent = category.name;
                    nameEl.style.cssText = 'margin: 0; color: white; font-size: 16px;';

                    const descEl = document.createElement('p');
                    descEl.textContent = category.description || 'No description';
                    descEl.style.cssText = 'margin: 5px 0 0 0; color: rgba(255,255,255,0.7); font-size: 13px;';

                    const idEl = document.createElement('p');
                    idEl.textContent = `ID: ${category.categoryId}`;
                    idEl.style.cssText = 'margin: 3px 0 0 0; color: rgba(255,255,255,0.5); font-size: 12px; font-family: monospace;';

                    infoDiv.appendChild(nameEl);
                    infoDiv.appendChild(descEl);
                    infoDiv.appendChild(idEl);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.style.cssText = 'display: flex; gap: 10px; margin-left: 15px;';

                    const editBtn = document.createElement('button');
                    editBtn.textContent = ' Edit';
                    editBtn.className = 'action-btn';
                    editBtn.style.cssText = 'padding: 8px 12px; font-size: 13px; margin: 0;';
                    editBtn.addEventListener('click', () => this.openCategoryModal(category.categoryId));

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = ' Delete';
                    deleteBtn.className = 'action-btn';
                    deleteBtn.style.cssText = 'padding: 8px 12px; font-size: 13px; margin: 0; background: rgba(255, 107, 107, 0.8);';
                    deleteBtn.addEventListener('click', () => this.deleteCategory(category.categoryId, category.name));

                    actionsDiv.appendChild(editBtn);
                    actionsDiv.appendChild(deleteBtn);

                    categoryItem.appendChild(infoDiv);
                    categoryItem.appendChild(actionsDiv);
                    listEl.appendChild(categoryItem);
                });
            }

            async deleteCategory(categoryId, categoryName) {
                const confirmed = confirm(`Are you sure you want to delete the category "${categoryName}"? This action cannot be undone.`);

                if (!confirmed) return;

                try {
                    await window.JuiceAuth.deleteCategory(categoryId);
                    alert(`Category "${categoryName}" deleted successfully.`);
                    this.loadCategoriesList();
                    this.loadCategoriesDropdown();
                } catch (error) {
                    console.error('Error deleting category:', error);
                    alert(`Error deleting category: ${error.message}`);
                }
            }

            async loadCategoriesDropdown() {
                try {
                    const dropdown = document.getElementById('card-category');
                    if (!dropdown) return;

                    const categories = await window.JuiceAuth.getCategories();

                    // Clear existing options
                    dropdown.innerHTML = '<option value="">-- Select a category --</option>';

                    // Add categories dynamically
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.categoryId;
                        option.textContent = category.name;
                        dropdown.appendChild(option);
                    });

                    console.log(`Loaded ${categories.length} categories into dropdown`);
                } catch (error) {
                    console.error('Error loading categories dropdown:', error);
                }
            }

            createNewProfile() {
                const name = this.profileNameInput.value.trim();
                if (!name) {
                    alert('Please enter a name');
                    return;
                }

                const newProfile = {
                    id: Date.now().toString(),
                    name: name,
                    xp: 0,
                    currentLevel: 1,
                    totalCards: 0,
                    correctCards: 0,
                    createdAt: new Date().toISOString()
                };

                this.profiles.push(newProfile);
                this.saveProfiles();
                this.renderProfileList();
                this.profileNameInput.value = '';
            }

            selectProfile(profileId) {
                this.currentProfile = this.profiles.find(p => p.id === profileId);

                // Don't auto-load card sets - require manual selection from dropdown
                // If you want to restore auto-loading, uncomment below:
                // if (this.currentProfile && this.currentProfile.selectedCardSet) {
                //     this.handleCardSetSelection(this.currentProfile.selectedCardSet);
                // }

                this.startSession();
            }

            async startSession() {
                if (!this.currentProfile) {
                    alert('Please select a profile first.');
                    return;
                }

                // If no cards are loaded, show category selection modal
                if (this.cards.length === 0) {
                    await this.showCategorySelectionModal();
                    return;
                }

                // Load card difficulties from cloud
                await this.loadCardDifficulties();

                // Build weighted shuffled deck based on difficulties
                this.cards = this.buildWeightedDeck();

                this.sessionStartTime = Date.now();
                this.currentCardIndex = 0;
                this.showStudyScreen();
                this.displayCard();
            }

            showStudyScreen() {
                this.hideAllScreens();
                this.studyScreen.classList.add('active');
                this.updateFooter();
            }

            displayCard() {
                if (this.currentCardIndex >= this.cards.length) {
                    this.endSession();
                    return;
                }

                const card = this.cards[this.currentCardIndex];
                console.log('Displaying card:', card);
                console.log('Card text value:', card.text);

                // Remove animation classes and reset to initial state
                this.flipCard.classList.remove('flipped', 'unflipped');

                // Force reflow to reset animation state
                void this.flipCard.offsetHeight;

                // Clear input and comparison display
                this.userAnswerInput.value = '';
                this.comparisonSection.classList.remove('show');

                // Render front card
                this.renderClozeText(card.text, this.frontCloze, true);
                // Render back card
                this.renderClozeText(card.text, this.backCloze, false);

                // Scroll card into view
                setTimeout(() => {
                    this.flipCardContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 50);

                // Focus input for next answer
                this.userAnswerInput.focus();
            }

            renderClozeText(text, element, isFront) {
                let processed = text;
                let firstAnswer = '';

                console.log(`renderClozeText called - isFront: ${isFront}, text: ${text}`);

                processed = processed.replace(/\{\{c(\d+)::([^}]+)\}\}/g, (match, num, answer) => {
                    if (num === '1') firstAnswer = answer;

                    if (isFront) {
                        if (num === '1') {
                            return '<span class="cloze-blank">_____</span>';
                        } else {
                            return '<span class="cloze-hint">' + answer + '</span>';
                        }
                    } else {
                        return '<span class="cloze-complete">' + answer + '</span>';
                    }
                });

                console.log(`Processed HTML: ${processed}`);
                console.log(`Target element:`, element);
                element.innerHTML = processed;
                console.log(`Element innerHTML after set:`, element.innerHTML);

                // Store for validation
                if (isFront) {
                    this.currentCardAnswer = firstAnswer;
                }
            }

            toggleFlip() {
                const userAnswer = this.userAnswerInput.value.trim();

                // Only allow flipping if there's an answer
                if (!userAnswer) {
                    return;
                }

                // First validate the answer
                this.validateAnswer(userAnswer);

                // Then trigger the flip animation
                // Force a reflow to ensure browser registers the DOM change
                // before applying the CSS transition
                setTimeout(() => {
                    // Access offsetHeight to force a reflow
                    void this.flipCard.offsetHeight;
                    this.flipCard.classList.add('flipped');
                }, 50);
            }

            validateAnswer(userAnswer) {
                let feedbackResult;

                // Try to use imported validation function from AnswerValidation module
                if (typeof AnswerValidation !== 'undefined' && AnswerValidation.compare && typeof AnswerValidation.compare === 'function') {
                    const result = AnswerValidation.compare(userAnswer, this.currentCardAnswer);

                    // Convert AnswerValidation response format to our feedback format
                    let cssClass = 'feedback-incorrect';
                    if (result.status === 'perfect') {
                        cssClass = 'feedback-correct';
                    } else if (result.status === 'close' || result.status === 'close_spelling') {
                        cssClass = 'feedback-close';
                    } else if (result.status === 'acceptable') {
                        cssClass = 'feedback-acceptable';
                    } else if (result.status === 'forbidden') {
                        cssClass = 'feedback-forbidden';
                    }

                    feedbackResult = {
                        status: result.status,
                        cssClass: cssClass,
                        message: result.feedback,
                        award: result.award
                    };
                } else {
                    // Fallback simple validation
                    const userNorm = userAnswer.trim().toLowerCase();
                    const correctNorm = this.currentCardAnswer.trim().toLowerCase();

                    if (userNorm === correctNorm) {
                        feedbackResult = {
                            status: 'perfect',
                            cssClass: 'feedback-correct',
                            message: ' Perfect! Exact match.',
                            award: 100
                        };
                    } else {
                        feedbackResult = {
                            status: 'incorrect',
                            cssClass: 'feedback-incorrect',
                            message: ' Not quite. Try again!',
                            award: 0
                        };
                    }
                }

                this.comparisonSection.classList.add('show');
                this.yourAnswerDisplay.textContent = userAnswer;
                this.expectedAnswerDisplay.textContent = this.currentCardAnswer;

                this.feedbackMessage.className = 'feedback-message ' + feedbackResult.cssClass;
                this.feedbackMessage.textContent = feedbackResult.message;

                // Store feedback for rating calculation
                this.lastFeedback = feedbackResult;
            }

            async submitRating(rating) {
                // Calculate XP
                let xpGained = 0;

                // Use the stored feedback object
                if (!this.lastFeedback) {
                    console.warn('No feedback stored');
                    this.nextCard();
                    return;
                }

                const feedbackClass = this.lastFeedback.cssClass;

                if (feedbackClass.includes('feedback-correct')) {
                    xpGained = 100;
                } else if (feedbackClass.includes('feedback-close')) {
                    xpGained = 75;
                } else if (feedbackClass.includes('feedback-acceptable')) {
                    xpGained = 50;
                } else if (feedbackClass.includes('feedback-incorrect')) {
                    xpGained = 0;
                } else if (feedbackClass.includes('feedback-forbidden')) {
                    xpGained = -10;
                }

                // Apply rating bonus
                if (rating === 'good') xpGained = Math.floor(xpGained * 1.25);
                if (rating === 'easy') xpGained = Math.floor(xpGained * 1.5);

                this.currentProfile.xp += Math.max(0, xpGained);
                this.currentProfile.currentLevel = Math.floor(this.currentProfile.xp / 100) + 1;
                this.currentProfile.totalCards++;

                if (feedbackClass.includes('feedback-correct') || feedbackClass.includes('feedback-close')) {
                    this.currentProfile.correctCards++;
                }

                // Save card difficulty rating (to Firestore or queue if offline)
                try {
                    const currentCard = this.cards[this.currentCardIndex];
                    const session = window.JuiceAuth.getCurrentSession();
                    if (session && currentCard && currentCard.id) {
                        // Map rating to difficulty tier
                        const difficultyMap = {
                            'again': 'Again',
                            'hard': 'Hard',
                            'good': 'Good',
                            'easy': 'Easy'
                        };
                        const difficulty = difficultyMap[rating] || 'Medium';

                        try {
                            // Try to save to Firestore (will succeed if online)
                            await window.JuiceAuth.saveCardRating(session.username, this.currentProfile.id, currentCard.id, difficulty);
                            console.log(`Card ${currentCard.id} saved to Firestore`);
                        } catch (firestoreError) {
                            // If Firestore save fails (likely offline), queue the rating for later sync
                            console.warn('Firestore save failed, queuing rating for later sync:', firestoreError);
                            const queued = window.JuiceAuth.queueCardRating(session.username, this.currentProfile.id, currentCard.id, difficulty);
                            if (queued) {
                                console.log(`Card ${currentCard.id} queued for sync when online`);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Error saving card rating:', error);
                    // Continue anyway - ratings are queued and will sync when online
                }

                this.updateFooter();
                this.nextCard();
            }

            nextCard() {
                this.currentCardIndex++;
                this.displayCard();
            }

            updateFooter() {
                this.currentProfileDisplay.textContent = `Profile: ${this.currentProfile.name}`;
                this.currentLevelDisplay.textContent = this.currentProfile.currentLevel;
                this.currentXpDisplay.textContent = `${this.currentProfile.xp} XP`;
            }

            endSession() {
                this.saveProfiles();
                this.showProfileScreen();
            }

            async saveProfiles() {
                // Save to localStorage
                localStorage.setItem('juice_profiles', JSON.stringify(this.profiles));

                // Save to cloud if user is logged in
                const session = window.JuiceAuth.getCurrentSession();
                if (session) {
                    try {
                        await window.JuiceAuth.saveProfilesToCloud(this.profiles);
                    } catch (e) {
                        console.warn('Could not save profiles to cloud:', e);
                        // Continue anyway - profiles are saved locally
                    }
                }
            }

            // ====== ANALYTICS SCREEN METHODS ======
            async showAnalyticsScreen() {
                this.hideAllScreens();
                this.analyticsScreen.classList.add('active');
                await this.loadAnalyticsData();
            }

            async loadAnalyticsData() {
                const session = window.JuiceAuth.getCurrentSession();
                if (!session) return;

                try {
                    // Load card histories from Firestore
                    const cardHistories = await window.JuiceAuth.loadCardHistories(session.username, this.currentProfile.id);

                    // Calculate statistics
                    const accuracy = this.calculateAccuracy();
                    const streak = this.calculateStreak();
                    const totalCards = this.currentProfile.stats?.totalCards || 0;
                    const studyTime = this.calculateStudyTime();
                    const topStruggledCards = this.getTopStruggledCards(cardHistories);

                    // Update stats display
                    document.getElementById('accuracy-display').textContent = accuracy.toFixed(1) + '%';
                    document.getElementById('streak-display').textContent = streak + ' days';
                    document.getElementById('cards-studied-display').textContent = totalCards;
                    document.getElementById('study-time-display').textContent = this.formatMinutes(studyTime);

                    // Populate struggled cards list
                    this.renderStruggledCards(topStruggledCards);

                    // Initialize charts
                    this.initCharts(cardHistories);
                } catch (error) {
                    console.error('Error loading analytics data:', error);
                    alert('Could not load analytics data. Please try again.');
                }
            }

            calculateAccuracy() {
                const total = this.currentProfile.stats?.totalCards || 0;
                if (total === 0) return 0;
                const correct = this.currentProfile.stats?.correctCards || 0;
                return (correct / total) * 100;
            }

            calculateStreak() {
                // Track consecutive days studied
                // Get last study date from profile
                const lastStudiedAt = this.currentProfile.lastStudiedAt;

                if (!lastStudiedAt) {
                    return 0; // No study data yet
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0); // Start of today

                const lastStudyDate = new Date(lastStudiedAt);
                lastStudyDate.setHours(0, 0, 0, 0); // Start of last study day

                const daysDiff = Math.floor((today - lastStudyDate) / (1000 * 60 * 60 * 24));

                // If studied today or yesterday, streak is active
                // If studied more than 1 day ago, streak is broken
                if (daysDiff === 0) {
                    // Studied today - return current streak
                    return this.currentProfile.stats?.currentStreak || 1;
                } else if (daysDiff === 1) {
                    // Studied yesterday - return current streak (streak continues)
                    return this.currentProfile.stats?.currentStreak || 1;
                } else {
                    // More than 1 day gap - streak is broken
                    return 0;
                }
            }

            calculateStudyTime() {
                // Convert total study time from seconds to minutes
                const totalStudyTimeSeconds = this.currentProfile.stats?.totalStudyTime || 0;
                return Math.floor(totalStudyTimeSeconds / 60);
            }

            formatMinutes(minutes) {
                if (minutes < 60) {
                    return minutes + ' min';
                } else {
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    return hours + 'h ' + mins + 'm';
                }
            }

            getTopStruggledCards(cardHistories) {
                // Get cards marked as "Again" (most difficult)
                const struggledCards = [];

                for (const cardId in cardHistories) {
                    const history = cardHistories[cardId];
                    if (history.difficulty === 'Again') {
                        const card = this.cards.find(c => c.id === cardId);
                        if (card) {
                            struggledCards.push({
                                id: cardId,
                                front: card.front,
                                back: card.back
                            });
                        }
                    }
                }

                // Return top 10
                return struggledCards.slice(0, 10);
            }

            renderStruggledCards(cards) {
                const container = document.getElementById('struggled-cards-list');
                if (!container) return;

                container.innerHTML = '';

                if (cards.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No struggled cards yet! Keep studying!</p>';
                    return;
                }

                cards.forEach((card, index) => {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'struggled-card-item';
                    cardEl.innerHTML = `
                        <div class="struggled-card-index">${index + 1}</div>
                        <div class="struggled-card-content">
                            <div class="struggled-card-front">${card.front}</div>
                            <div class="struggled-card-back">${card.back}</div>
                        </div>
                    `;
                    container.appendChild(cardEl);
                });
            }

            initCharts(cardHistories) {
                // Calculate difficulty distribution
                const distribution = {
                    'Again': 0,
                    'Hard': 0,
                    'Medium': 0,
                    'Good': 0,
                    'Easy': 0
                };

                for (const cardId in cardHistories) {
                    const difficulty = cardHistories[cardId].difficulty || 'Medium';
                    if (distribution.hasOwnProperty(difficulty)) {
                        distribution[difficulty]++;
                    }
                }

                // Initialize Chart.js charts if available
                if (typeof Chart !== 'undefined') {
                    this.createDifficultyChart(distribution);
                    this.createAccuracyChart();
                }
            }

            createDifficultyChart(distribution) {
                const ctx = document.getElementById('difficulty-chart');
                if (!ctx) return;

                if (this.difficultyChart) {
                    this.difficultyChart.destroy();
                }

                this.difficultyChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Again', 'Hard', 'Medium', 'Good', 'Easy'],
                        datasets: [{
                            data: [
                                distribution['Again'],
                                distribution['Hard'],
                                distribution['Medium'],
                                distribution['Good'],
                                distribution['Easy']
                            ],
                            backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            createAccuracyChart() {
                const ctx = document.getElementById('accuracy-trend-chart');
                if (!ctx) return;

                if (this.accuracyChart) {
                    this.accuracyChart.destroy();
                }

                // Generate mock trend data for last 7 days
                const labels = [];
                const data = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    // Mock data with some randomness
                    data.push(Math.floor(Math.random() * 40) + 60);
                }

                this.accuracyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Accuracy %',
                            data: data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointBackgroundColor: '#3b82f6'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            // ====== SETTINGS SCREEN METHODS ======
            async showSettingsScreen() {
                this.hideAllScreens();
                this.settingsScreen.classList.add('active');
                await this.loadSettingsData();
            }

            async loadSettingsData() {
                const session = window.JuiceAuth.getCurrentSession();
                if (!session) return;

                // Populate account info
                document.getElementById('settings-username').textContent = session.username;
                document.getElementById('settings-level').textContent = this.currentProfile.currentLevel;
                document.getElementById('settings-xp').textContent = this.currentProfile.xp;

                // Show admin button if user is admin
                try {
                    const isAdmin = await window.JuiceAuth.isUserAdmin(session.username);
                    console.log('Is admin user:', session.username, '=', isAdmin);
                    const adminAccessSection = document.getElementById('admin-access-section');
                    if (adminAccessSection) {
                        adminAccessSection.style.display = isAdmin ? 'block' : 'none';
                    }
                } catch (error) {
                    console.error('Error checking admin status:', error);
                }
            }

            async handleChangePIN() {
                const oldPin = document.getElementById('current-pin').value.trim();
                const newPin = document.getElementById('new-pin').value.trim();
                const confirmPin = document.getElementById('confirm-pin').value.trim();

                // Validate
                if (!oldPin || !newPin || !confirmPin) {
                    alert('Please fill in all PIN fields');
                    return;
                }

                if (newPin !== confirmPin) {
                    alert('New PIN and confirmation do not match');
                    return;
                }

                if (!/^\d{4}$/.test(newPin)) {
                    alert('PIN must be exactly 4 digits');
                    return;
                }

                const session = window.JuiceAuth.getCurrentSession();
                if (!session) return;

                try {
                    // Verify old PIN by checking it matches current session
                    const verify = await window.JuiceAuth.signIn(session.username, oldPin);
                    if (!verify) {
                        alert('Current PIN is incorrect');
                        return;
                    }

                    // Change PIN in Firestore
                    await window.JuiceAuth.changePin(session.username, oldPin, newPin);
                    alert('PIN changed successfully!');

                    // Clear form
                    document.getElementById('change-pin-form').reset();
                } catch (error) {
                    console.error('Error changing PIN:', error);
                    alert('Could not change PIN. Please try again.');
                }
            }

            handleSavePreferences() {
                const dailyGoal = document.getElementById('daily-goal').value;
                const cardsPerSession = document.getElementById('cards-per-session').value;
                const enableNotifications = document.getElementById('enable-notifications').checked;

                // Save to localStorage for now
                localStorage.setItem('juice_preferences', JSON.stringify({
                    dailyGoal: dailyGoal,
                    cardsPerSession: cardsPerSession,
                    enableNotifications: enableNotifications
                }));

                alert('Preferences saved!');
            }

            async handleLogout() {
                const confirmed = confirm('Are you sure you want to logout?');
                if (!confirmed) return;

                // Clear admin navigation stack when logging out
                window.JuiceAuth.clearAdminNavigationStack();

                await window.JuiceAuth.signOut();
                this.showLoginScreen();
            }

            // ====== CARD EDITING METHODS ======

            async loadCardSetsForEditing() {
                try {
                    const selector = document.getElementById('card-set-selector-admin');
                    if (!selector) return;

                    const cardSets = await window.JuiceAuth.getCardSets();
                    selector.innerHTML = '<option value="">-- Choose a card set --</option>';

                    cardSets.forEach(set => {
                        const option = document.createElement('option');
                        option.value = set.setId;
                        option.textContent = `${set.name} (${set.cardCount || 0} cards)`;
                        selector.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading card sets:', error);
                }
            }

            async handleCardSetSelectionForEditing(setId) {
                const container = document.getElementById('cards-list-container');
                const cardsList = document.getElementById('cards-list');
                const deleteBtn = document.getElementById('delete-card-set-btn');

                if (!setId) {
                    container.style.display = 'none';
                    if (deleteBtn) {
                        deleteBtn.style.display = 'none';
                    }
                    return;
                }

                try {
                    const cardSets = await window.JuiceAuth.getCardSets();
                    const selectedSet = cardSets.find(s => s.setId === setId);

                    if (!selectedSet || !selectedSet.cards) {
                        cardsList.innerHTML = '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.6);">No cards in this set</div>';
                        container.style.display = 'block';
                        if (deleteBtn) {
                            deleteBtn.style.display = 'inline-block';
                        }
                        return;
                    }

                    this.currentEditingSetId = setId;
                    this.renderCardsList(selectedSet.cards);
                    container.style.display = 'block';

                    // Show delete button when a card set is selected
                    if (deleteBtn) {
                        deleteBtn.style.display = 'inline-block';
                    }
                } catch (error) {
                    console.error('Error loading cards:', error);
                    cardsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #ff6b6b;">Error loading cards</div>';
                    container.style.display = 'block';
                    if (deleteBtn) {
                        deleteBtn.style.display = 'inline-block';
                    }
                }
            }

            renderCardsList(cards) {
                const cardsList = document.getElementById('cards-list');
                cardsList.innerHTML = '';

                cards.forEach((card, index) => {
                    const cardEl = document.createElement('div');
                    cardEl.style.cssText = 'padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;';

                    const textEl = document.createElement('div');
                    textEl.style.cssText = 'flex: 1;';
                    textEl.innerHTML = `
                        <div style="color: white; font-weight: 500; margin-bottom: 4px;">Card ${index + 1}</div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${(card.question || card.text || 'No question').substring(0, 60)}...
                        </div>
                    `;

                    const editBtn = document.createElement('button');
                    editBtn.className = 'admin-action-btn';
                    editBtn.textContent = ' Edit';
                    editBtn.addEventListener('click', () => this.openEditCardModal(card, this.currentEditingSetId));

                    cardEl.appendChild(textEl);
                    cardEl.appendChild(editBtn);
                    cardsList.appendChild(cardEl);
                });
            }

            openEditCardModal(card, setId) {
                this.currentEditingCard = { ...card };
                this.currentEditingSetId = setId;

                // Fill form fields
                document.getElementById('edit-card-question').value = card.question || card.text || '';
                document.getElementById('edit-card-answer').value = card.answer || '';
                document.getElementById('edit-card-category').value = card.category || '';
                document.getElementById('edit-card-tags').value = card.tags || '';

                // Show modal
                document.getElementById('edit-card-modal').style.display = 'block';

                // Update preview
                this.updateCardPreview();
            }

            closeEditCardModal() {
                document.getElementById('edit-card-modal').style.display = 'none';
                document.getElementById('edit-status').innerHTML = '';
                document.getElementById('cloze-errors').innerHTML = '';
                this.currentEditingCard = null;
            }

            updateCardPreview() {
                const question = document.getElementById('edit-card-question').value;
                const preview = document.getElementById('card-preview');
                const errorsEl = document.getElementById('cloze-errors');
                const clozeFieldsList = document.getElementById('cloze-fields-list');
                const noClozeFields = document.getElementById('no-cloze-fields');

                if (!question.trim()) {
                    preview.innerHTML = '<p style="color: rgba(255,255,255,0.7); margin: 0;"><em>Enter a question with fill-in-the-blank fields...</em></p>';
                    noClozeFields.style.display = 'block';
                    clozeFieldsList.style.display = 'none';
                    errorsEl.innerHTML = '';
                    return;
                }

                // Validate cloze syntax
                const validation = CSVValidator.validateClozeSyntax(question);

                if (!validation.valid) {
                    errorsEl.innerHTML = validation.errors.map(e => `<div style="color: #ff6b6b; font-size: 13px; margin: 4px 0;"> ${e}</div>`).join('');
                } else {
                    errorsEl.innerHTML = '';
                }

                if (validation.warnings.length > 0) {
                    errorsEl.innerHTML += validation.warnings.map(w => `<div style="color: #ffc107; font-size: 13px; margin: 4px 0;"> ${w}</div>`).join('');
                }

                // Render cloze fields list
                if (validation.fieldCount > 0) {
                    noClozeFields.style.display = 'none';
                    clozeFieldsList.style.display = 'block';

                    let html = '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                    validation.fields.forEach(field => {
                        html += `
                            <div style="background: rgba(255,215,0,0.2); border: 1px solid rgba(255,215,0,0.5); padding: 8px 12px; border-radius: 4px; color: white; font-size: 13px;">
                                <strong>Blank ${field.number}:</strong> ${field.content}
                            </div>
                        `;
                    });
                    html += '</div>';
                    clozeFieldsList.innerHTML = html;
                } else {
                    noClozeFields.style.display = 'block';
                    clozeFieldsList.style.display = 'none';
                }

                // Show preview
                const previewHtml = this.renderClozePreview(question);
                preview.innerHTML = previewHtml;
            }

            renderClozePreview(text) {
                const clozeRegex = /\{\{c(\d+)::([^}]+)\}\}/g;
                let processed = text;
                let firstAnswer = '';

                processed = processed.replace(clozeRegex, (match, num, answer) => {
                    if (num === '1') firstAnswer = answer;
                    if (num === '1') {
                        return '<span style="background: rgba(255,215,0,0.3); border: 1px dashed rgba(255,215,0,0.7); padding: 2px 8px; border-radius: 3px;">_____</span>';
                    } else {
                        return `<span style="background: rgba(255,215,0,0.5); color: white; padding: 2px 6px; border-radius: 3px;">${answer}</span>`;
                    }
                });

                return processed || '<em style="color: rgba(255,255,255,0.5);">Preview will appear here...</em>';
            }

            async handleSaveCard() {
                if (!this.currentEditingCard || !this.currentEditingSetId) {
                    alert('No card selected');
                    return;
                }

                const question = document.getElementById('edit-card-question').value.trim();
                const answer = document.getElementById('edit-card-answer').value.trim();
                const category = document.getElementById('edit-card-category').value.trim();
                const tags = document.getElementById('edit-card-tags').value.trim();
                const statusEl = document.getElementById('edit-status');

                if (!question) {
                    statusEl.innerHTML = '<span style="color: #ff6b6b;">Question is required</span>';
                    return;
                }

                // Validate cloze syntax
                const validation = CSVValidator.validateClozeSyntax(question);
                if (!validation.valid) {
                    statusEl.innerHTML = `<span style="color: #ff6b6b;">Invalid question format: ${validation.errors[0]}</span>`;
                    return;
                }

                try {
                    statusEl.innerHTML = '<span style="color: rgba(255,255,255,0.7);">Saving...</span>';

                    const updatedCard = {
                        question: question,
                        answer: answer,
                        category: category,
                        tags: tags
                    };

                    const result = await window.JuiceAuth.updateCard(
                        this.currentEditingSetId,
                        this.currentEditingCard.id,
                        updatedCard
                    );

                    statusEl.innerHTML = '<span style="color: #51cf66;"> Card saved successfully!</span>';

                    // Reload cards list after a short delay
                    setTimeout(async () => {
                        this.handleCardSetSelectionForEditing(this.currentEditingSetId);
                        this.closeEditCardModal();
                    }, 1000);

                } catch (error) {
                    console.error('Error saving card:', error);
                    statusEl.innerHTML = `<span style="color: #ff6b6b;">Error: ${error.message}</span>`;
                }
            }

            async handleDeleteCard() {
                if (!this.currentEditingCard || !this.currentEditingSetId) {
                    alert('No card selected');
                    return;
                }

                const confirmed = confirm('Are you sure you want to delete this card? This cannot be undone.');
                if (!confirmed) return;

                const statusEl = document.getElementById('edit-status');

                try {
                    statusEl.innerHTML = '<span style="color: rgba(255,255,255,0.7);">Deleting...</span>';

                    const result = await window.JuiceAuth.deleteCard(
                        this.currentEditingSetId,
                        this.currentEditingCard.id
                    );

                    statusEl.innerHTML = '<span style="color: #51cf66;"> Card deleted successfully!</span>';

                    // Reload cards list and close modal
                    setTimeout(async () => {
                        this.handleCardSetSelectionForEditing(this.currentEditingSetId);
                        this.closeEditCardModal();
                    }, 1000);

                } catch (error) {
                    console.error('Error deleting card:', error);
                    statusEl.innerHTML = `<span style="color: #ff6b6b;">Error: ${error.message}</span>`;
                }
            }

            async handleDeleteCardSet() {
                const setId = document.getElementById('card-set-selector-admin').value;

                if (!setId) {
                    alert('Please select a card set to delete');
                    return;
                }

                try {
                    // Get the card set details to show in confirmation
                    const cardSets = await window.JuiceAuth.getCardSets();
                    const selectedSet = cardSets.find(s => s.setId === setId);

                    if (!selectedSet) {
                        alert('Card set not found');
                        return;
                    }

                    // Show confirmation dialog with details
                    const cardCount = selectedSet.cards ? selectedSet.cards.length : 0;
                    const confirmed = confirm(
                        `Are you sure you want to delete "${selectedSet.name}"?\n\n` +
                        `This card set contains ${cardCount} cards and cannot be undone.`
                    );

                    if (!confirmed) return;

                    const deleteBtn = document.getElementById('delete-card-set-btn');
                    deleteBtn.textContent = ' Deleting...';
                    deleteBtn.disabled = true;

                    const result = await window.JuiceAuth.deleteCardSet(setId);

                    deleteBtn.textContent = ' Delete This Card Set';
                    deleteBtn.disabled = false;

                    alert(` Card set "${selectedSet.name}" deleted successfully!`);

                    // Reset UI
                    document.getElementById('card-set-selector-admin').value = '';
                    deleteBtn.style.display = 'none';

                    // Reload card sets list
                    await this.loadCardSetsForEditing();

                } catch (error) {
                    console.error('Error deleting card set:', error);
                    const deleteBtn = document.getElementById('delete-card-set-btn');
                    deleteBtn.textContent = ' Delete This Card Set';
                    deleteBtn.disabled = false;
                    alert(`Error deleting card set: ${error.message}`);
                }
            }

            // ====== ADMIN SCREEN METHODS ======

            async handleAdminBackButton() {
                // Save current scroll position before leaving
                window.JuiceAuth.savePageScrollState('admin-dashboard');

                // Get the previous page from navigation stack
                const prevPage = window.JuiceAuth.getAdminPreviousPage();

                if (prevPage) {
                    // Navigate back to previous page
                    this.showAdminScreen();
                    // Restore scroll position
                    setTimeout(() => {
                        window.JuiceAuth.restorePageScrollState(prevPage.page);
                    }, 100);
                } else {
                    // No previous page, go back to login
                    window.JuiceAuth.clearAdminNavigationStack();
                    await window.JuiceAuth.signOut();
                    this.showLoginScreen();
                }
            }

            async showAdminScreen() {
                // Check if user is admin
                const session = window.JuiceAuth.getCurrentSession();
                if (!session) {
                    this.showLoginScreen();
                    return;
                }

                const isAdmin = await window.JuiceAuth.isUserAdmin(session.username);
                if (!isAdmin) {
                    alert('You do not have admin access');
                    return;
                }

                this.hideAllScreens();
                this.adminScreen.classList.add('active');

                // Save navigation state for back button
                window.JuiceAuth.saveAdminNavigationState('admin-dashboard');

                await this.loadAllUsers();
                await this.loadCategoriesDropdown();
                await this.loadCategoriesList();
                await this.loadCardSetsForEditing();

                // Restore scroll position if returning from another page
                window.JuiceAuth.restorePageScrollState('admin-dashboard');
            }

            async loadAllUsers() {
                try {
                    const users = await window.JuiceAuth.getAllUsers();
                    this.renderUsersList(users);
                } catch (error) {
                    console.error('Error loading users:', error);
                    alert('Could not load user list');
                }
            }

            renderUsersList(users) {
                const tbody = document.getElementById('users-table-body');
                if (!tbody) return;

                tbody.innerHTML = '';

                users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.level || 'N/A'}</td>
                        <td>${user.xp || 0}</td>
                        <td>${user.accuracy ? user.accuracy.toFixed(1) + '%' : 'N/A'}</td>
                        <td>${user.lastActive ? new Date(user.lastActive).toLocaleDateString() : 'N/A'}</td>
                        <td>
                            <button class="admin-action-btn reset-pin-btn" data-username="${user.username}">Reset PIN</button>
                            <button class="admin-action-btn delete-user-btn" data-username="${user.username}">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    // Add event listeners to action buttons
                    tr.querySelector('.reset-pin-btn').addEventListener('click', () => this.handleResetUserPIN(user.username));
                    tr.querySelector('.delete-user-btn').addEventListener('click', () => this.handleDeleteUser(user.username));
                });
            }

            showAdminModal() {
                const modal = document.getElementById('admin-modal');
                if (modal) {
                    modal.classList.add('show');
                }
            }

            closeAdminModal() {
                const modal = document.getElementById('admin-modal');
                if (modal) {
                    modal.classList.remove('show');
                }
            }

            async handleCreateAdmin() {
                const username = document.getElementById('new-admin-username').value.trim();
                const pin = document.getElementById('new-admin-pin').value.trim();

                if (!username || !pin) {
                    alert('Please fill in all fields');
                    return;
                }

                if (!/^[a-zA-Z0-9]{2,20}$/.test(username)) {
                    alert('Username must be 2-20 alphanumeric characters');
                    return;
                }

                if (!/^\d{4}$/.test(pin)) {
                    alert('PIN must be exactly 4 digits');
                    return;
                }

                try {
                    await window.JuiceAuth.createAdminAccount(username, pin);
                    alert('Admin account created successfully!');
                    document.getElementById('create-admin-form').reset();
                    this.closeAdminModal();
                    await this.loadAllUsers();
                } catch (error) {
                    console.error('Error creating admin:', error);
                    alert('Could not create admin account: ' + error.message);
                }
            }

            async handleResetUserPIN(username) {
                const newPin = prompt('Enter new PIN for user ' + username + ' (4 digits):');
                if (!newPin) return;

                if (!/^\d{4}$/.test(newPin)) {
                    alert('PIN must be exactly 4 digits');
                    return;
                }

                try {
                    await window.JuiceAuth.resetUserPIN(username, newPin);
                    alert('PIN reset successfully!');
                    await this.loadAllUsers();
                } catch (error) {
                    console.error('Error resetting PIN:', error);
                    alert('Could not reset PIN: ' + error.message);
                }
            }

            async handleDeleteUser(username) {
                const confirmed = confirm('Are you sure you want to delete user ' + username + ' and all their data?');
                if (!confirmed) return;

                try {
                    await window.JuiceAuth.deleteUser(username);
                    alert('User deleted successfully!');
                    await this.loadAllUsers();
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Could not delete user: ' + error.message);
                }
            }

            // ====== CARD UPLOAD METHODS ======
            uploadedCSVContent = null;
            uploadedCSVValidation = null;

            showUploadModal() {
                const modal = document.getElementById('upload-modal');
                if (modal) {
                    modal.style.display = 'block';
                    // Reset upload state
                    this.uploadedCSVContent = null;
                    this.uploadedCSVValidation = null;
                    document.getElementById('file-selection-step').style.display = 'block';
                    document.getElementById('validation-step').style.display = 'none';
                    document.getElementById('category-step').style.display = 'none';
                    document.getElementById('validate-csv-btn').style.display = 'none';
                    document.getElementById('upload-cards-confirm-btn').style.display = 'none';
                    document.getElementById('upload-status').textContent = '';
                    document.getElementById('upload-status').className = '';
                }
            }

            closeUploadModal() {
                const modal = document.getElementById('upload-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.processFile(file);
                }
            }

            handleFileDrop(file) {
                this.processFile(file);
            }

            processFile(file) {
                if (!file.name.endsWith('.csv')) {
                    alert('Please select a CSV file');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.uploadedCSVContent = e.target.result;
                    this.showValidationStep();
                };
                reader.onerror = () => {
                    alert('Error reading file');
                };
                reader.readAsText(file);
            }

            showValidationStep() {
                document.getElementById('file-selection-step').style.display = 'none';
                document.getElementById('validation-step').style.display = 'block';
                document.getElementById('validate-csv-btn').style.display = 'inline-block';
                this.validateUploadedCSV();
            }

            validateUploadedCSV() {
                if (!this.uploadedCSVContent) {
                    alert('No file loaded');
                    return;
                }

                // Validate using CSVValidator module
                const validation = CSVValidator.validateCSV(this.uploadedCSVContent);
                this.uploadedCSVValidation = validation;

                // Display validation messages
                const messagesDiv = document.getElementById('validation-messages');
                messagesDiv.innerHTML = '';

                if (validation.errors.length > 0) {
                    const errorTitle = document.createElement('div');
                    errorTitle.className = 'validation-message error';
                    errorTitle.innerHTML = `<strong> Errors Found (${validation.errors.length})</strong>`;
                    messagesDiv.appendChild(errorTitle);

                    validation.errors.forEach(error => {
                        const msg = document.createElement('div');
                        msg.className = 'validation-message error';
                        msg.textContent = error;
                        messagesDiv.appendChild(msg);
                    });
                }

                if (validation.warnings.length > 0) {
                    const warningTitle = document.createElement('div');
                    warningTitle.className = 'validation-message warning';
                    warningTitle.innerHTML = `<strong> Warnings (${validation.warnings.length})</strong>`;
                    messagesDiv.appendChild(warningTitle);

                    validation.warnings.forEach(warning => {
                        const msg = document.createElement('div');
                        msg.className = 'validation-message warning';
                        msg.textContent = warning;
                        messagesDiv.appendChild(msg);
                    });
                }

                if (validation.valid) {
                    const successMsg = document.createElement('div');
                    successMsg.className = 'validation-message success';
                    successMsg.innerHTML = `<strong> CSV Valid!</strong> ${validation.data.length} cards ready to import`;
                    messagesDiv.appendChild(successMsg);

                    // Show preview
                    const previewHtml = CSVValidator.generatePreview(validation, 10);
                    document.getElementById('csv-preview').innerHTML = previewHtml;

                    // Show category step
                    document.getElementById('category-step').style.display = 'block';
                    document.getElementById('upload-cards-confirm-btn').style.display = 'inline-block';
                    document.getElementById('validate-csv-btn').style.display = 'none';

                    // Load categories dropdown
                    this.loadCategoriesDropdown();
                } else {
                    const errorCount = document.createElement('div');
                    errorCount.className = 'validation-message error';
                    errorCount.innerHTML = `<strong> CSV Invalid - ${validation.errors.length} error(s)</strong>`;
                    messagesDiv.appendChild(errorCount);

                    // Hide category and confirm steps
                    document.getElementById('category-step').style.display = 'none';
                    document.getElementById('upload-cards-confirm-btn').style.display = 'none';
                }
            }

            async confirmUploadCards() {
                if (!this.uploadedCSVValidation || !this.uploadedCSVValidation.valid) {
                    alert('Please fix CSV errors first');
                    return;
                }

                const category = document.getElementById('card-category').value;
                if (!category) {
                    alert('Please select a product category');
                    return;
                }

                const statusDiv = document.getElementById('upload-status');
                statusDiv.textContent = 'Uploading cards to Firestore...';
                statusDiv.className = 'loading';

                try {
                    // Get current session for uploadedBy field
                    const session = window.JuiceAuth.getCurrentSession();
                    if (!session) {
                        throw new Error('No active session - please login first');
                    }

                    // Create set ID from category (lowercase, replace spaces with hyphens)
                    const setId = category.toLowerCase().replace(/\s+/g, '-');

                    // Prepare card set data
                    const setData = {
                        name: category,  // Display name
                        category: category,  // Category for filtering
                        description: `Flashcards for ${category}`,
                        cards: this.uploadedCSVValidation.data,  // Array of validated cards
                        uploadedBy: session.username  // Track which admin uploaded
                    };

                    // Save to Firestore using the new function
                    const result = await window.JuiceAuth.saveCardSet(setId, setData);

                    // Also save to localStorage as a backup
                    const cardSetKey = `juice_cards_${category}`;
                    localStorage.setItem(cardSetKey, JSON.stringify(this.uploadedCSVValidation.data));

                    statusDiv.textContent = ` ${result.message}`;
                    statusDiv.className = 'success';

                    console.log(`Card set saved: ${setId}`, result);

                    // Close modal after 2 seconds
                    setTimeout(() => {
                        this.closeUploadModal();
                    }, 2000);
                } catch (error) {
                    console.error('Error uploading cards:', error);
                    statusDiv.textContent = ` Error uploading cards: ${error.message}`;
                    statusDiv.className = 'error';
                }
            }
        }

        // Initialize app
        window.app = new JuiceFlashcardApp();
    </script>
</body>
</html>
