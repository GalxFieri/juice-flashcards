rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions for custom username/PIN auth

    /**
     * Verify PIN hash
     * Note: We cannot do SHA-256 hashing in security rules,
     * so we rely on client-side validation with server-side caching verification.
     * The client validates the PIN and the server accepts changes from authenticated sessions.
     */
    function isAuthenticatedUser(username) {
      // For now, we rely on client-side PIN validation since Firestore rules
      // don't support cryptographic hashing. The app validates PIN before making requests.
      // In a production app, consider using Firebase Authentication with custom claims
      // or a Cloud Function as a gatekeeper for sensitive operations.
      return true;
    }

    // Allow anyone to query the users collection to check username availability during signup
    match /users/{username} {
      // Allow read to check if user exists (for signup validation only, limit 1 result)
      allow read: if request.query.limit == 1;

      // Allow create for new users (signup) - only if user doesn't exist
      allow create: if !exists(/databases/$(database)/documents/users/$(username));

      // Allow update to user's own profile (after client-side PIN validation)
      // Updates include: pinHash, lastLoginAt, pinResetAt
      allow update: if isAuthenticatedUser(username);

      // Allow read for authenticated users (after PIN validation in client)
      allow read: if isAuthenticatedUser(username);
    }

    // User subcollections (profiles with card history)
    // Allow read/write to user's own profiles only
    match /users/{username}/profiles/{profileId} {
      allow read, write: if isAuthenticatedUser(username);
    }

    // Card history subcollections
    // Allow read/write to user's own card history only
    match /users/{username}/profiles/{profileId}/cardHistory/{cardId} {
      allow read, write: if isAuthenticatedUser(username);
    }

    // Categories collection (read-only for all, write for admins)
    match /categories/{categoryId} {
      allow read: if true;  // All users can read categories for dropdown selector
      allow write: if isAuthenticatedUser('admin');  // Only admins can create/edit/delete categories
    }

    // Public card sets collection (read-only for all, write for admins)
    match /cardSets/{setId} {
      allow read: if true;  // All users can read card sets for study
      allow write: if isAuthenticatedUser(resource.data.uploadedBy);  // Only the uploader (admin) can modify
    }

    // Public leaderboards (read-only)
    match /leaderboards/{document=**} {
      allow read: if true;
      allow write: if false;
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}